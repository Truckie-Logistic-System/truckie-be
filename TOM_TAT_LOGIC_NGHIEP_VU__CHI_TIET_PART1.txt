â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    TÃ“M Táº®T LOGIC CÃC LUá»’NG NGHIá»†P Vá»¤ CHÃNH                   â•‘
â•‘                  Há»† THá»NG QUáº¢N LÃ Váº¬N CHUYá»‚N - TRUCKIE                       â•‘
â•‘                              PHáº¦N 1/2                                         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

================================================================================
1. LOGIC Äá»€ XUáº¤T XE HÃ€NG (BINPACKER ALGORITHM)
================================================================================

ğŸ“Œ Má»¤C ÄÃCH:
   Tá»± Ä‘á»™ng phÃ¢n bá»• cÃ¡c kiá»‡n hÃ ng vÃ o xe phÃ¹ há»£p, tá»‘i Æ°u hÃ³a sá»‘ lÆ°á»£ng xe cáº§n dÃ¹ng
   vÃ  Ä‘áº£m báº£o táº­n dá»¥ng tá»‘i Ä‘a trá»ng táº£i cá»§a tá»«ng xe.

ğŸ“‹ CÆ  CHáº¾ HOáº T Äá»˜NG:

   BÆ¯á»šC 1: CHUáº¨N Bá»Š Dá»® LIá»†U
   â€¢ Láº¥y danh sÃ¡ch OrderDetail (kiá»‡n hÃ ng) vÃ  SizeRule (loáº¡i xe)
   â€¢ SizeRule sáº¯p xáº¿p: trá»ng táº£i > chiá»u dÃ i > chiá»u rá»™ng > chiá»u cao
   â€¢ Validate: kiá»‡n hÃ ng khÃ´ng vÆ°á»£t xe lá»›n nháº¥t

   BÆ¯á»šC 2: CHUYá»‚N Äá»”I Dá»® LIá»†U
   â€¢ OrderDetail â†’ BoxItem: id, kÃ­ch thÆ°á»›c (mâ†’unitsÃ—10), weight (táº¥nâ†’gram), volume

   BÆ¯á»šC 3: Sáº®P Xáº¾P KIá»†N HÃ€NG THÃ”NG MINH
   Æ¯u tiÃªn: Density (máº­t Ä‘á»™) > Volume > Weight > Longest Dimension
   â€¢ HÃ ng náº·ng Ä‘áº·c (>15kg/dmÂ³) Ä‘áº·t trÆ°á»›c
   â€¢ Kiá»‡n lá»›n Ä‘áº·t trÆ°á»›c kiá»‡n nhá»

   BÆ¯á»šC 4: THUáº¬T TOÃN Äáº¶T HÃ€NG (3D BIN PACKING)
   
   CHIáº¾N LÆ¯á»¢C 1: Äáº¶T VÃ€O XE HIá»†N CÃ“
   â€¢ Sáº¯p xáº¿p xe theo combined utilization: (weightÃ—0.6 + volumeÃ—0.4)
   â€¢ Thá»­ Ä‘áº·t vÃ o tá»«ng extreme point vá»›i 6 cÃ¡ch xoay
   â€¢ Kiá»ƒm tra: khÃ´ng vÆ°á»£t kÃ­ch thÆ°á»›c, khÃ´ng va cháº¡m, khÃ´ng quÃ¡ táº£i
   â€¢ Cáº­p nháº­t extreme points má»›i: (x+lx,y,z), (x,y+ly,z), (x,y,z+lz)
   
   CHIáº¾N LÆ¯á»¢C 2: NÃ‚NG Cáº¤P XE
   â€¢ Náº¿u khÃ´ng Ä‘áº·t Ä‘Æ°á»£c â†’ thá»­ nÃ¢ng lÃªn loáº¡i xe lá»›n hÆ¡n
   â€¢ Re-pack toÃ n bá»™ kiá»‡n cÅ© vÃ o xe má»›i
   â€¢ Lá»£i Ã­ch: 1 xe lá»›n thay vÃ¬ 2 xe nhá»
   
   CHIáº¾N LÆ¯á»¢C 3: Má» XE Má»šI
   â€¢ TÃ­nh fit score = (dimensionÃ—0.3 + weightÃ—0.35 + volumeÃ—0.35)
   â€¢ Bonus +0.2 náº¿u 0.4 â‰¤ score â‰¤ 0.7 (sweet spot)
   â€¢ Chá»n xe cÃ³ fit score cao nháº¥t

   BÆ¯á»šC 5: THá»NG KÃŠ
   â€¢ Weight utilization: currentWeight/maxWeight Ã— 100%
   â€¢ Volume utilization: usedVolume/totalVolume Ã— 100%
   â€¢ Cáº£nh bÃ¡o: Heavy-Dense, Light-Bulky, Inefficient, Excellent

ğŸ¯ OUTPUT: List<ContractRuleAssignResponse> vá»›i vehicleIndex, sizeRule, 
   assignedDetails, packedDetails (vá»‹ trÃ­ 3D)


================================================================================
2. LOGIC TÃNH TIá»€N Há»¢P Äá»’NG (PRICING CALCULATION)
================================================================================

ğŸ“Œ Má»¤C ÄÃCH:
   TÃ­nh chi phÃ­ váº­n chuyá»ƒn dá»±a trÃªn khoáº£ng cÃ¡ch, loáº¡i xe, trá»ng lÆ°á»£ng,
   vÃ  Ã¡p dá»¥ng phá»¥ phÃ­ (báº£o hiá»ƒm, hÃ ng dá»… vá»¡, vÆ°á»£t táº£i).

ğŸ“‹ CÆ  CHáº¾ HOáº T Äá»˜NG:

   KHÃI NIá»†M QUAN TRá»ŒNG:
   â€¢ totalValue: giÃ¡ tá»± Ä‘á»™ng tá»« há»‡ thá»‘ng
   â€¢ adjustedValue: giÃ¡ Staff Ä‘iá»u chá»‰nh
   â€¢ effectiveValue = adjustedValue > 0 ? adjustedValue : totalValue
   â†’ LuÃ´n Æ°u tiÃªn adjustedValue!

   BÆ¯á»šC 1: GIÃ CÆ  Báº¢N
   basePrice = basingPrice.pricePerKm Ã— actualDistance
   
   Tra cá»©u BasingPrice theo: vehicleTypeId, categoryId, distanceRange

   BÆ¯á»šC 2: PHá»¤ PHÃ Báº¢O HIá»‚M
   IF hasInsurance THEN
       rate = category=NORMAL ? 0.08% : 0.15%
       insuranceSurcharge = SUM(declaredValue) Ã— rate
   END IF

   BÆ¯á»šC 3: PHá»¤ PHÃ HÃ€NG Dá»„ Vá» 
   IF category = FRAGILE THEN
       fragileSurcharge = basePrice Ã— 20%
   END IF

   BÆ¯á»šC 4: PHá»¤ PHÃ VÆ¯á»¢T Táº¢I
   IF totalWeight > maxWeight THEN
       overweightRatio = (totalWeight - maxWeight) / maxWeight
       overweightSurcharge = basePrice Ã— overweightRatio Ã— 50%
   END IF

   BÆ¯á»šC 5: Tá»”NG GIÃ
   totalPrice = basePrice + insuranceSurcharge + fragileSurcharge + overweightSurcharge
   
   BÆ¯á»šC 6: TIá»€N Äáº¶T Cá»ŒC
   depositPercent = contract.customDepositPercent ?? globalDepositPercent
   deposit = effectiveValue Ã— depositPercent / 100

ğŸ¯ OUTPUT: PriceCalculationResponse vá»›i breakdown chi tiáº¿t tá»«ng bÆ°á»›c tÃ­nh


================================================================================
3. LOGIC PHÃ‚N CÃ”NG XE VÃ€ TÃ€I Xáº¾ (DRIVER ASSIGNMENT)
================================================================================

ğŸ“Œ Má»¤C ÄÃCH:
   Gá»£i Ã½ xe vÃ  tÃ i xáº¿ phÃ¹ há»£p nháº¥t cho tá»«ng chuyáº¿n hÃ ng.

ğŸ“‹ CÆ  CHáº¾ HOáº T Äá»˜NG:

   BÆ¯á»šC 1: Lá»ŒC XE
   Äiá»u kiá»‡n: ACTIVE, Ä‘Ãºng vehicleType, khÃ´ng bá»‹ exclude, khÃ´ng reserved,
   Ä‘Äƒng kiá»ƒm/báº£o hiá»ƒm cÃ²n háº¡n, khÃ´ng cÃ³ active assignment
   â†’ Sáº¯p xáº¿p theo usage (Ã­t dÃ¹ng lÃªn Ä‘áº§u)

   BÆ¯á»šC 2: Lá»ŒC TÃ€I Xáº¾
   Äiá»u kiá»‡n: ACTIVE, licenseClass phÃ¹ há»£p, khÃ´ng active assignment,
   khÃ´ng bá»‹ exclude, khÃ´ng cÃ³ assignment cÃ¹ng ngÃ y

   BÆ¯á»šC 3: CHáº¤M ÄIá»‚M TÃ€I Xáº¾ (Ä‘iá»ƒm tháº¥p = Æ°u tiÃªn cao)
   
   Factor 1: LICENSE CLASS (0-200 Ä‘iá»ƒm)
   â€¢ B2: 0 Ä‘iá»ƒm, C: 100 Ä‘iá»ƒm
   
   Factor 2: FAMILIARITY (-600 to 0 Ä‘iá»ƒm)
   â€¢ Tá»«ng lÃ¡i xe nÃ y: -500 Ä‘iá»ƒm (BIG BONUS)
   â€¢ Driver1 cuá»‘i: thÃªm -100 Ä‘iá»ƒm
   
   Factor 3: RECENT ACTIVITY (0-200 Ä‘iá»ƒm)
   â€¢ score += recentActivity Ã— 20
   â€¢ 0 chuyáº¿n: +0, 10 chuyáº¿n: +200
   
   Factor 4: WORKLOAD BALANCE (0-350 Ä‘iá»ƒm)
   â€¢ <30% avg: +250 (Ã­t kinh nghiá»‡m)
   â€¢ 70-130% avg: +0 (SWEET SPOT)
   â€¢ >180% avg: +350 (quÃ¡ táº£i)
   
   Factor 5: VIOLATIONS (0-300 Ä‘iá»ƒm)
   â€¢ score += violationCount Ã— 60
   
   Factor 6: TIME SINCE LAST ASSIGNMENT (0-400 Ä‘iá»ƒm)
   â€¢ <1 ngÃ y: +400 (vá»«a cháº¡y)
   â€¢ >30 ngÃ y: +0 (nghá»‰ lÃ¢u, Æ°u tiÃªn cao)

   BÆ¯á»šC 4: Sáº®P Xáº¾P VÃ€ CHá»ŒN
   â€¢ Sort theo totalScore (tháº¥p â†’ cao)
   â€¢ Chá»n top 6 tÃ i xáº¿/xe
   â€¢ ÄÃ¡nh dáº¥u top 2 lÃ  "recommended"

ğŸ¯ OUTPUT: List<VehicleSuggestionResponse> (top 5 xe) vá»›i
   List<DriverSuggestionResponse> (top 6 tÃ i xáº¿/xe)


================================================================================
4. LOGIC TÃNH CÆ¯á»šC TRáº¢ HÃ€NG (RETURN SHIPPING COST)
================================================================================

ğŸ“Œ Má»¤C ÄÃCH:
   TÃ­nh chi phÃ­ tráº£ hÃ ng khi ngÆ°á»i nháº­n tá»« chá»‘i.

ğŸ“‹ CÆ  CHáº¾ HOáº T Äá»˜NG:

   BÆ¯á»šC 1: XÃC Äá»ŠNH KIá»†N TRáº¢
   â€¢ Staff chá»n OrderDetail bá»‹ tá»« chá»‘i
   â€¢ Link vÃ o Issue.orderDetails
   â†’ CHá»ˆ tÃ­nh cÆ°á»›c cho kiá»‡n Ä‘Æ°á»£c chá»n

   BÆ¯á»šC 2: TÃNH KHOáº¢NG CÃCH
   â€¢ Máº·c Ä‘á»‹nh: deliveryAddress â†’ pickupAddress
   â€¢ Hoáº·c dÃ¹ng actualDistanceKm tá»« FE (náº¿u cÃ³ waypoints)

   BÆ¯á»šC 3: XÃC Äá»ŠNH LOáº I XE
   â€¢ TÃ¬m ContractRule chá»©a OrderDetail
   â€¢ Láº¥y SizeRuleEntity
   â€¢ Äáº¿m: vehicleCountMap[sizeRuleId]++

   BÆ¯á»šC 4: TÃNH GIÃ
   priceResponse = contractService.calculateTotalPrice(
       contract, distanceKm, vehicleCountMap
   )
   â†’ DÃ¹ng cÃ´ng thá»©c GIá»NG giÃ¡ gá»‘c

   BÆ¯á»šC 5: CHO PHÃ‰P ÄIá»€U CHá»ˆNH
   finalFee = adjustedReturnFee ?? calculatedFee
   
   Staff cÃ³ thá»ƒ giáº£m/tÄƒng giÃ¡ tÃ¹y trÆ°á»ng há»£p

   BÆ¯á»šC 6: Táº O TRANSACTION
   â€¢ type: RETURN_SHIPPING
   â€¢ amount: finalFee
   â€¢ deadline: NOW + 24h
   â€¢ Sau thanh toÃ¡n â†’ táº¡o returnJourney

ğŸ¯ OUTPUT: ReturnShippingFeeResponse vá»›i calculatedFee, adjustedFee, 
   finalFee, distanceKm, priceDetails
