â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    TÃ“M Táº®T LOGIC CÃC LUá»’NG NGHIá»†P Vá»¤ CHÃNH                   â•‘
â•‘                  Há»† THá»NG QUáº¢N LÃ Váº¬N CHUYá»‚N - TRUCKIE                       â•‘
â•‘                              PHáº¦N 2/2                                         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

================================================================================
5. NGHIá»†P Vá»¤ Xá»¬ LÃ Bá»’I THÆ¯á»œNG (COMPENSATION)
================================================================================

ğŸ“Œ Má»¤C ÄÃCH:
   Xá»­ lÃ½ bá»“i thÆ°á»ng khi hÃ ng hÃ³a bá»‹ hÆ° há»ng/máº¥t mÃ¡t trong quÃ¡ trÃ¬nh váº­n chuyá»ƒn.

ğŸ“‹ CÆ  CHáº¾ HOáº T Äá»˜NG:

   BÆ¯á»šC 1: STAFF THáº¨M Äá»ŠNH
   
   1.1. ThÃ´ng tin hÃ ng hÃ³a
   â€¢ hasDocuments: cÃ³ chá»©ng tá»« há»£p lá»‡? (hÃ³a Ä‘Æ¡n, bill...)
   â€¢ documentValue: giÃ¡ trá»‹ ghi trÃªn chá»©ng tá»«
   â€¢ estimatedMarketValue: giÃ¡ Æ°á»›c tÃ­nh náº¿u khÃ´ng cÃ³ chá»©ng tá»«
   â€¢ documentImages: áº£nh chá»©ng tá»« (upload Cloudinary)
   
   1.2. Má»©c Ä‘á»™ hÆ° há»ng
   â€¢ assessmentRatePercent: % hÆ° há»ng (0-100%)
     - 50% = há»ng má»™t ná»­a
     - 100% = há»ng toÃ n bá»™/máº¥t hÃ ng
   
   1.3. PhÃ¡t hiá»‡n gian láº­n
   IF fraudDetected = TRUE THEN
       â†’ Ban account customer (status = BANNED)
       â†’ Issue.status = CLOSED_FRAUD
       â†’ KHÃ”NG bá»“i thÆ°á»ng
   END IF

   BÆ¯á»šC 2: TÃNH Bá»’I THÆ¯á»œNG HÃ€NG HÆ¯ Há»NG (DAMAGE)
   
   KÃ­ hiá»‡u:
   â€¢ V_thá»±c_táº¿: GiÃ¡ trá»‹ thá»±c táº¿ hÃ ng
   â€¢ V_khai_bÃ¡o: declaredValue
   â€¢ V_chá»©ng_tá»«: documentValue
   â€¢ T_hÆ°: assessmentRate (0.0-1.0)
   â€¢ C_total: tá»•ng cÆ°á»›c
   â€¢ W_kiá»‡n: trá»ng lÆ°á»£ng kiá»‡n hÆ°
   â€¢ W_total: tá»•ng trá»ng lÆ°á»£ng
   
   2.1. XÃ¡c Ä‘á»‹nh V_thá»±c_táº¿
   
   IF hasDocuments = TRUE AND documentValue > 0 THEN
       IF documentValue < declaredValue THEN
           V_thá»±c_táº¿ = documentValue
           Note = "CT < KB: Äá»n theo CT"
       ELSE IF documentValue = declaredValue THEN
           V_thá»±c_táº¿ = documentValue
           Note = "CT = KB: Khá»›p hoÃ n toÃ n"
       ELSE  // documentValue > declaredValue
           V_thá»±c_táº¿ = declaredValue
           Note = "CT > KB: Äá»n tá»‘i Ä‘a theo KB (Under-insured)"
       END IF
   ELSE
       IF estimatedMarketValue > 0 THEN
           V_thá»±c_táº¿ = estimatedMarketValue
           Note = "KhÃ´ng CT: DÃ¹ng giÃ¡ Æ°á»›c tÃ­nh"
       ELSE
           V_thá»±c_táº¿ = declaredValue
           Note = "KhÃ´ng CT: DÃ¹ng KB"
       END IF
   END IF
   
   2.2. TÃ­nh C_hÆ° (cÆ°á»›c váº­n chuyá»ƒn tá»· lá»‡)
   
   weightRatio = W_kiá»‡n / W_total
   freightRefund = C_total Ã— weightRatio Ã— T_hÆ°
   
   VÃ­ dá»¥:
   â€¢ CÆ°á»›c 1,000,000 VNÄ
   â€¢ Kiá»‡n hÆ° 0.5 táº¥n / Tá»•ng 2 táº¥n = 25%
   â€¢ HÆ° 50%
   â†’ C_hÆ° = 1,000,000 Ã— 0.25 Ã— 0.5 = 125,000 VNÄ
   
   2.3. TÃ­nh V_lá»— (giÃ¡ trá»‹ máº¥t mÃ¡t)
   
   valueLoss = V_thá»±c_táº¿ Ã— T_hÆ°
   
   2.4. TÃ­nh B_hÃ ng (bá»“i thÆ°á»ng hÃ ng hÃ³a)
   
   legalLimit = C_total Ã— 10  // Giá»›i háº¡n phÃ¡p luáº­t: 10Ã— cÆ°á»›c
   
   CASE 1: CÃ³ BH + CÃ³ CT â†’ KhÃ´ng giá»›i háº¡n
   IF hasInsurance = TRUE AND hasDocuments = TRUE THEN
       goodsCompensation = MIN(valueLoss, declaredValue)
   
   CASE 2: CÃ³ BH + KhÃ´ng CT â†’ BH vÃ´ hiá»‡u, Ã¡p dá»¥ng 10Ã—
   ELSE IF hasInsurance = TRUE AND hasDocuments = FALSE THEN
       goodsCompensation = MIN(valueLoss, legalLimit)
   
   CASE 3: KhÃ´ng BH + CÃ³ CT â†’ Ãp dá»¥ng 10Ã—
   ELSE IF hasInsurance = FALSE AND hasDocuments = TRUE THEN
       goodsCompensation = MIN(valueLoss, legalLimit)
   
   CASE 4: KhÃ´ng BH + KhÃ´ng CT â†’ Ãp dá»¥ng 10Ã—
   ELSE
       goodsCompensation = MIN(valueLoss, legalLimit)
   END IF
   
   2.5. TÃ­nh B_tá»•ng
   
   totalCompensation = goodsCompensation + freightRefund
   
   // Fix CASE 2: Cap tá»•ng á»Ÿ legal limit
   IF hasInsurance = TRUE AND hasDocuments = FALSE THEN
       IF totalCompensation > legalLimit THEN
           totalCompensation = legalLimit
       END IF
   END IF

   BÆ¯á»šC 3: TÃNH Bá»’I THÆ¯á»œNG Lá»†CH TUYáº¾N (OFF_ROUTE)
   
   Äáº·c Ä‘iá»ƒm:
   â€¢ T_hÆ° = 100% (coi nhÆ° máº¥t hÃ ng)
   â€¢ KHÃ”NG giá»›i háº¡n 10Ã— (lá»—i cá»‘ Ã½)
   â€¢ B_hÃ ng = 100% V_thá»±c_táº¿
   â€¢ C_hÆ° = 100% C_total
   
   totalCompensation = V_thá»±c_táº¿ + C_total

   BÆ¯á»šC 4: Táº O REFUND
   
   Náº¿u Staff chá»n "Táº¡o refund":
   
   refund = {
       issueId, refundAmount: finalCompensation,
       bankName, accountNumber, accountHolderName,
       transactionCode, bankTransferImage, notes,
       refundDate: NOW, processedByStaff
   }

   BÆ¯á»šC 5: Cáº¬P NHáº¬T TRáº NG THÃI
   
   IF fraudDetected = TRUE THEN
       issue.status = CLOSED_FRAUD
       banCustomer(customer)
   ELSE
       issue.status = RESOLVED
   END IF

ğŸ” ÄIá»‚M Äáº¶C BIá»†T:
   â€¢ CÃ³ BH + CÃ³ CT má»›i Ä‘á»n khÃ´ng giá»›i háº¡n
   â€¢ Giá»›i háº¡n 10Ã— = tá»•ng cÆ°á»›c (khÃ´ng pháº£i cÆ°á»›c tá»· lá»‡)
   â€¢ So sÃ¡nh CT vs KB Ä‘á»ƒ xÃ¡c Ä‘á»‹nh giÃ¡ trá»‹ thá»±c
   â€¢ OFF_ROUTE: khÃ´ng giá»›i háº¡n, Ä‘á»n 100%
   â€¢ Fraud detection â†’ ban account tá»± Ä‘á»™ng

ğŸ¯ OUTPUT: CompensationDetailResponse vá»›i assessment, compensationBreakdown
   (goodsCompensation, freightRefund, totalCompensation, legalLimit, case, 
   explanation), refundInfo


================================================================================
6. LOGIC CHECK OFF ROUTE (PHÃT HIá»†N Lá»†CH TUYáº¾N)
================================================================================

ğŸ“Œ Má»¤C ÄÃCH:
   GiÃ¡m sÃ¡t GPS, phÃ¡t hiá»‡n tÃ i xáº¿ lá»‡ch tuyáº¿n, cáº£nh bÃ¡o Staff ká»‹p thá»i.

ğŸ“‹ CÆ  CHáº¾ HOáº T Äá»˜NG:

   BÆ¯á»šC 1: NHáº¬N VÃ€ Xá»¬ LÃ GPS
   
   processLocationUpdate(vehicleAssignmentId, lat, lng, speed, bearing) {
       journey = findLatestActiveJourney(vehicleAssignmentId)
       
       IF journey = NULL OR segments = NULL THEN
           RETURN NULL
       END IF
       
       distanceToRoute = calculateDistanceToRoute(lat, lng, segments)
       
       IF distanceToRoute > MAX_DISTANCE (500m) THEN
           handleOffRoute(assignment, lat, lng, distanceToRoute)
       ELSE
           handleBackOnRoute(vehicleAssignmentId)
       END IF
   }

   BÆ¯á»šC 2: TÃNH KHOáº¢NG CÃCH Äáº¾N ROUTE
   
   calculateDistanceToRoute(lat, lng, segments) {
       minDistance = INFINITY
       
       FOR each segment:
           points = segment.routePolyline
           
           FOR i = 0 TO points.length - 1:
               distance = distanceToLineSegment(
                   currentPos: (lat, lng),
                   lineSegment: (points[i], points[i+1])
               )
               
               minDistance = MIN(minDistance, distance)
           END FOR
       END FOR
       
       RETURN minDistance (meters)
   }
   
   â€¢ DÃ¹ng Haversine formula
   â€¢ TÃ­nh Ä‘áº¿n táº¥t cáº£ segments
   â€¢ Tráº£ vá» khoáº£ng cÃ¡ch ngáº¯n nháº¥t

   BÆ¯á»šC 3: Xá»¬ LÃ KHI Lá»†CH TUYáº¾N
   
   handleOffRoute(assignment, lat, lng, distanceToRoute) {
       existingEvent = findActiveByVehicleAssignmentId(assignment.id)
       
       IF existingEvent EXISTS THEN
           // Cáº­p nháº­t event hiá»‡n cÃ³
           
           // CRITICAL: Chá»‰ update náº¿u váº«n active
           IF warningStatus IN [ISSUE_CREATED, RESOLVED_SAFE, BACK_ON_ROUTE] THEN
               RETURN
           END IF
           
           event.previousDistanceFromRouteMeters = event.distanceFromRouteMeters
           event.lastKnownLat = lat
           event.lastKnownLng = lng
           event.distanceFromRouteMeters = distanceToRoute
           event.lastLocationUpdateAt = NOW
           
           checkWarningThresholds(event)
       ELSE
           // Táº¡o event má»›i
           newEvent = {
               vehicleAssignment, order,
               offRouteStartTime: NOW,
               lastKnownLat, lastKnownLng,
               distanceFromRouteMeters: distanceToRoute,
               lastLocationUpdateAt: NOW,
               warningStatus: NONE,
               canContactDriver: NULL,
               gracePeriodExtensionCount: 0
           }
           save(newEvent)
       END IF
   }

   BÆ¯á»šC 4: Há»† THá»NG Cáº¢NH BÃO PHÃ‚N Cáº¤P
   
   checkWarningThresholds(event) {
       // CRITICAL: KhÃ´ng cáº£nh bÃ¡o náº¿u khÃ´ng active
       IF warningStatus IN [ISSUE_CREATED, RESOLVED_SAFE, BACK_ON_ROUTE] THEN
           RETURN
       END IF
       
       durationMinutes = NOW - offRouteStartTime
       minutesSinceLastContact = NOW - contactedAt
       
       YELLOW WARNING (5 phÃºt):
       IF warningStatus = NONE AND durationMinutes >= 5 THEN
           event.warningStatus = YELLOW_SENT
           event.yellowWarningSentAt = NOW
           sendWarningToStaff(event, "YELLOW")
       END IF
       
       RED WARNING (10 phÃºt):
       IF warningStatus = YELLOW_SENT THEN
           shouldSendRed = FALSE
           
           IF contactedAt = NULL THEN
               // ChÆ°a liÃªn há»‡ â†’ dÃ¹ng tá»•ng thá»i gian
               shouldSendRed = durationMinutes >= 10
           ELSE
               // ÄÃ£ liÃªn há»‡ â†’ dÃ¹ng thá»i gian tá»« láº§n cuá»‘i
               shouldSendRed = minutesSinceLastContact >= 10
           END IF
           
           IF shouldSendRed THEN
               event.warningStatus = RED_SENT
               event.redWarningSentAt = NOW
               sendWarningToStaff(event, "RED")
           END IF
       END IF
   }

   BÆ¯á»šC 5: Gá»¬I Cáº¢NH BÃO QUA WEBSOCKET
   
   sendWarningToStaff(event, severity) {
       payload = {
           type: "OFF_ROUTE_WARNING",
           severity: "YELLOW" or "RED",
           offRouteEventId, vehicleAssignmentId, orderId, orderCode,
           offRouteDurationMinutes,
           lastKnownLocation: {lat, lng},
           distanceFromRouteMeters,
           driver: {id, fullName, phoneNumber},
           vehicle: {licensePlate, model},
           customer: {fullName, phoneNumber}
       }
       
       websocketService.sendToStaff("/topic/off-route-warnings", payload)
       
       // Gá»­i notification database
       createNotification(
           type: "OFF_ROUTE_WARNING",
           severity, message, staff
       )
   }

   BÆ¯á»šC 6: STAFF XÃC NHáº¬N LIÃŠN Há»†
   
   confirmContact(offRouteEventId, canContactDriver, reason) {
       event = findById(offRouteEventId)
       
       event.canContactDriver = canContactDriver
       event.contactedAt = NOW
       event.contactReason = reason
       
       IF canContactDriver = TRUE THEN
           event.warningStatus = RESOLVED_SAFE
           event.resolvedAt = NOW
           event.resolutionReason = "Staff confirmed driver is safe"
       ELSE
           // Driver khÃ´ng liÃªn láº¡c Ä‘Æ°á»£c
           
           IF gracePeriodExtensionCount < MAX_EXTENSIONS (3) THEN
               // Gia háº¡n grace period
               event.gracePeriodExtensionCount++
               event.warningStatus = YELLOW_SENT  // Reset vá» YELLOW
               event.yellowWarningSentAt = NOW
               event.contactedAt = NOW  // Reset timer
               
               sendWarningToStaff(event, "GRACE_PERIOD_EXTENDED")
           ELSE
               // Háº¿t gia háº¡n â†’ táº¡o Issue tá»± Ä‘á»™ng
               createRunawayIssue(event)
           END IF
       END IF
   }

   BÆ¯á»šC 7: Táº O ISSUE Tá»° Äá»˜NG
   
   createRunawayIssue(event) {
       issue = {
           order: event.order,
           vehicleAssignment: event.vehicleAssignment,
           issueType: "RUNAWAY_DRIVER",
           status: "PENDING",
           description: "Driver off-route >10 minutes, cannot contact",
           createdAt: NOW,
           offRouteEventId: event.id
       }
       save(issue)
       
       event.warningStatus = ISSUE_CREATED
       event.issueCreatedAt = NOW
       
       sendNotificationToManagement(issue)
   }

   BÆ¯á»šC 8: Xá»¬ LÃ KHI Vá»€ ÄÃšNG TUYáº¾N
   
   handleBackOnRoute(vehicleAssignmentId) {
       event = findActiveByVehicleAssignmentId(vehicleAssignmentId)
       
       IF event EXISTS AND warningStatus NOT IN [ISSUE_CREATED, BACK_ON_ROUTE] THEN
           event.warningStatus = BACK_ON_ROUTE
           event.resolvedAt = NOW
           event.resolutionReason = "Driver returned to route"
           save(event)
           
           sendNotificationToStaff(event, "BACK_ON_ROUTE")
       END IF
   }

   BÆ¯á»šC 9: JOB KIá»‚M TRA Äá»ŠNH Ká»² (Every 1 minute)
   
   @Scheduled(cron = "0 * * * * *")
   checkActiveOffRouteEvents() {
       activeEvents = findAllActiveEvents()
       
       FOR each event:
           checkWarningThresholds(event)
       END FOR
   }

ğŸ” ÄIá»‚M Äáº¶C BIá»†T:
   â€¢ NgÆ°á»¡ng: 500m, cáº£nh bÃ¡o vÃ ng 5 phÃºt, Ä‘á» 10 phÃºt
   â€¢ Sau liÃªn há»‡ â†’ reset timer (tÃ­nh tá»« contactedAt)
   â€¢ Gia háº¡n tá»‘i Ä‘a 3 láº§n (má»—i láº§n reset vá» YELLOW)
   â€¢ Tá»± Ä‘á»™ng táº¡o Issue náº¿u háº¿t gia háº¡n
   â€¢ WebSocket real-time cho Staff
   â€¢ Job Ä‘á»‹nh ká»³ 1 phÃºt kiá»ƒm tra

ğŸ¯ OUTPUT: OffRouteEventDetailResponse vá»›i offRouteStartTime, 
   offRouteDurationMinutes, lastKnownLocation, distanceFromRouteMeters,
   warningStatus, contactInfo, gracePeriodInfo


================================================================================
7. LOGIC TÃNH NHIÃŠN LIá»†U TIÃŠU THá»¤ (FUEL CONSUMPTION)
================================================================================

ğŸ“Œ Má»¤C ÄÃCH:
   TÃ­nh toÃ¡n nhiÃªn liá»‡u tiÃªu thá»¥ thá»±c táº¿ cá»§a xe sau má»—i chuyáº¿n hÃ ng,
   phá»¥c vá»¥ quáº£n lÃ½ chi phÃ­ váº­n hÃ nh vÃ  Ä‘á»‘i soÃ¡t vá»›i hÃ³a Ä‘Æ¡n nhiÃªn liá»‡u.

ğŸ“‹ FLOW Tá»”NG QUAN:

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  TÃ i xáº¿ upload  â”‚â”€â”€â”€â”€â–¶â”‚  Staff xÃ¡c nháº­n â”‚â”€â”€â”€â”€â–¶â”‚   TÃ­nh toÃ¡n     â”‚
   â”‚   áº£nh odometer  â”‚     â”‚   sá»‘ km (náº¿u    â”‚     â”‚   fuel volume   â”‚
   â”‚   (start/end)   â”‚     â”‚   cáº§n thiáº¿t)    â”‚     â”‚                 â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                                               â”‚
            â–¼                                               â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Auto-update    â”‚                           â”‚  Cáº­p nháº­t       â”‚
   â”‚  OrderDetail â†’  â”‚                           â”‚  Order/Vehicle  â”‚
   â”‚  PICKING_UP     â”‚                           â”‚  status         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“‹ CÆ  CHáº¾ HOáº T Äá»˜NG:

   BÆ¯á»šC 1: TÃ€I Xáº¾ UPLOAD áº¢NH Äá»’NG Há»’ (ODOMETER)
   
   â±ï¸ Xá»¬ LÃ: Äá»’NG Bá»˜ (Synchronous) - Blocking call
   ğŸ§µ LUá»’NG: Single-threaded (Main HTTP thread)
   
   Táº¡i 2 thá»i Ä‘iá»ƒm báº¯t buá»™c:
   â€¢ odometerAtStart: TrÆ°á»›c khi xuáº¥t phÃ¡t (upload láº§n Ä‘áº§u)
   â€¢ odometerAtEnd: Sau khi hoÃ n thÃ nh giao hÃ ng (upload láº§n cuá»‘i)
   
   createVehicleFuelConsumption(request) {
       // âš¡ SYNC: Validate vehicle assignment tá»“n táº¡i
       vehicleAssignment = findById(request.vehicleAssignmentId)
       
       // âš¡ SYNC: Check khÃ´ng cÃ³ record trÃ¹ng
       IF existingRecord.isPresent THEN
           THROW "ÄÃ£ tá»“n táº¡i record cho assignment nÃ y"
       END IF
       
       // âš¡ SYNC: Upload áº£nh lÃªn Cloudinary (blocking I/O)
       odometerAtStartUrl = cloudinaryService.uploadImage(
           request.odometerAtStartImage, 
           "vehicle-fuel/odometer-start"
       )
       
       // âš¡ SYNC: LÆ°u record vá»›i transaction
       @Transactional
       entity = {
           vehicleAssignment,
           odometerReadingAtStart: request.odometerReadingAtStart,
           odometerAtStartUrl: odometerAtStartUrl,
           dateRecorded: NOW
       }
       savedEntity = save(entity)
       
       // âš¡ SYNC: Auto-update cÃ¡c tráº¡ng thÃ¡i liÃªn quan
       TRY {
           // Cáº­p nháº­t OrderDetail â†’ PICKING_UP
           orderDetailStatusService.updateOrderDetailStatusByAssignment(
               request.vehicleAssignmentId,
               OrderDetailStatusEnum.PICKING_UP
           )
           
           // Cáº­p nháº­t Vehicle â†’ IN_TRANSIT
           vehicle.status = VehicleStatusEnum.IN_TRANSIT
           vehicleEntityService.save(vehicle)
       } CATCH (Exception e) {
           // âš ï¸ Non-critical: Log warning, khÃ´ng fail main operation
           LOG.warn("Failed to update related statuses: " + e.message)
       }
       
       RETURN mapToResponse(savedEntity)
   }

   BÆ¯á»šC 2: TÃNH NHIÃŠN LIá»†U KHI UPLOAD áº¢NH Káº¾T THÃšC
   
   â±ï¸ Xá»¬ LÃ: Äá»’NG Bá»˜ (Synchronous) vá»›i @Transactional
   ğŸ§µ LUá»’NG: Single-threaded (Main HTTP thread)
   ğŸ“Š Äá»˜ PHá»¨C Táº P: O(n) vá»›i n = sá»‘ order details
   
   updateFinalReading(request) {
       entity = findById(request.fuelConsumptionId)
       
       // âš¡ SYNC: Upload áº£nh odometer káº¿t thÃºc
       odometerAtEndUrl = cloudinaryService.uploadImage(
           request.odometerAtEndImage,
           "vehicle-fuel/odometer-end"
       )
       
       // Validate khoáº£ng cÃ¡ch há»£p lá»‡
       distanceTraveled = request.odometerReadingAtEnd - entity.odometerReadingAtStart
       
       IF distanceTraveled <= 0 THEN
           THROW "Sá»‘ km káº¿t thÃºc pháº£i lá»›n hÆ¡n sá»‘ km báº¯t Ä‘áº§u"
       END IF
       
       IF distanceTraveled > 10000 THEN
           THROW "Khoáº£ng cÃ¡ch di chuyá»ƒn khÃ´ng há»£p lá»‡ (>10,000km)"
       END IF
       
       // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       // TÃNH TOÃN NHIÃŠN LIá»†U - 2 PHÆ¯Æ NG PHÃP
       // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       
       vehicleType = assignment.vehicle.vehicleType
       baseFuelConsumption = vehicleType.averageFuelConsumptionLPer100km  // L/100km
       vehicleWeightLimit = vehicleType.weightLimitTon
       
       // PHÆ¯Æ NG PHÃP 1: ODOMETER-BASED (Æ¯u tiÃªn - ChÃ­nh xÃ¡c hÆ¡n)
       fuelVolume = calculateFuelConsumptionOdometerBased(
           vehicleAssignmentId,
           baseFuelConsumption,
           vehicleWeightLimit,
           distanceTraveled
       )
       
       // Náº¿u tháº¥t báº¡i â†’ FALLBACK sang Segment-based
       IF fuelVolume = NULL OR fuelVolume <= 0 THEN
           fuelVolume = calculateFuelConsumptionWithLoad(
               vehicleAssignmentId,
               baseFuelConsumption,
               vehicleWeightLimit,
               distanceTraveled
           )
       END IF
       
       // Cáº­p nháº­t entity
       entity.odometerReadingAtEnd = request.odometerReadingAtEnd
       entity.odometerAtEndUrl = odometerAtEndUrl
       entity.distanceTraveled = distanceTraveled
       entity.fuelVolume = fuelVolume
       save(entity)
       
       // âš¡ SYNC: Cascade status updates
       updateRelatedStatuses(entity)
       
       RETURN mapToResponse(entity)
   }

   BÆ¯á»šC 3: CÃ”NG THá»¨C TÃNH NHIÃŠN LIá»†U CHI TIáº¾T
   
   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘              PHÆ¯Æ NG PHÃP 1: ODOMETER-BASED (Æ¯U TIÃŠN)                  â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   
   calculateFuelConsumptionOdometerBased(assignmentId, baseFuel, weightLimit, actualDistanceKm) {
       
       // Láº¥y táº¥t cáº£ order details cá»§a assignment
       orderDetails = findByVehicleAssignmentId(assignmentId)
       
       IF orderDetails.isEmpty THEN
           // KhÃ´ng cÃ³ hÃ ng â†’ dÃ¹ng cÃ´ng thá»©c Ä‘Æ¡n giáº£n
           RETURN actualDistanceKm Ã— baseFuel / 100
       END IF
       
       // TÃ­nh tá»•ng trá»ng lÆ°á»£ng hÃ ng (loáº¡i bá» RETURNED/CANCELLED)
       totalCargoWeight = orderDetails.stream()
           .filter(od -> od.status NOT IN ["RETURNED", "CANCELLED"])
           .map(od -> od.weight ?? 0)
           .sum()
       
       // TÃ­nh Load Factor dá»±a trÃªn % táº£i trá»ng
       loadRatio = totalCargoWeight / vehicleWeightLimit
       
       // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       // LOAD FACTOR CALCULATION (TiÃªu thá»¥ nhiÃªn liá»‡u theo táº£i trá»ng)
       // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       //
       //   loadRatio     loadFactor    Giáº£i thÃ­ch
       //   â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       //   0%            1.0           Xe khÃ´ng (baseline)
       //   25%           1.05          TÄƒng 5% cho 1/4 táº£i
       //   50%           1.10          TÄƒng 10% cho 1/2 táº£i
       //   75%           1.15          TÄƒng 15% cho 3/4 táº£i
       //   100%          1.20          TÄƒng 20% cho full táº£i
       //   >100%         1.25          QuÃ¡ táº£i, max factor
       //
       // CÃ´ng thá»©c: loadFactor = 1.0 + (loadRatio Ã— 0.2)
       // Giá»›i háº¡n: 1.0 â‰¤ loadFactor â‰¤ 1.25
       // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       
       loadFactor = 1.0 + (MIN(loadRatio, 1.25) Ã— 0.2)
       loadFactor = MAX(1.0, MIN(loadFactor, 1.25))
       
       // CÃ´ng thá»©c cuá»‘i cÃ¹ng
       fuelVolume = (actualDistanceKm Ã— baseFuel Ã— loadFactor) / 100
       
       LOG.info("ğŸ“Š Odometer-based fuel calc: distance={}km, baseFuel={}L/100km, " +
                "cargoWeight={}T, loadRatio={}, loadFactor={}, fuelVolume={}L",
                actualDistanceKm, baseFuel, totalCargoWeight, loadRatio, loadFactor, fuelVolume)
       
       RETURN fuelVolume
   }
   
   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘           PHÆ¯Æ NG PHÃP 2: SEGMENT-BASED (FALLBACK LEGACY)              â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   
   calculateFuelConsumptionWithLoad(assignmentId, baseFuel, weightLimit, odoDistanceKm) {
       
       // Láº¥y journey vÃ  segments
       journey = findLatestByVehicleAssignmentId(assignmentId)
       
       IF journey = NULL THEN
           // Fallback: dÃ¹ng cÃ´ng thá»©c Ä‘Æ¡n giáº£n
           RETURN odoDistanceKm Ã— baseFuel / 100
       END IF
       
       segments = journey.segments.sortBy(segmentOrder)
       orderDetails = findByVehicleAssignmentId(assignmentId)
       
       totalFuel = 0
       
       FOR each segment IN segments:
           segmentDistance = segment.distanceKm
           
           // XÃ¡c Ä‘á»‹nh loáº¡i segment
           segmentType = segment.segmentType  // PICKUP, DELIVERY, RETURN, etc.
           
           // TÃ­nh cargo weight cho segment nÃ y
           cargoWeight = determineCargoWeightForSegment(segment, segmentType, orderDetails)
           
           // TÃ­nh load ratio vÃ  factor cho tá»«ng segment
           loadRatio = cargoWeight / vehicleWeightLimit
           loadFactor = 1.0 + (MIN(loadRatio, 1.0) Ã— 0.2)
           
           // TÃ­nh fuel cho segment
           segmentFuel = (segmentDistance Ã— baseFuel Ã— loadFactor) / 100
           totalFuel += segmentFuel
           
           LOG.info("ğŸ“ Segment {}: type={}, distance={}km, cargo={}T, factor={}, fuel={}L",
                    segment.segmentOrder, segmentType, segmentDistance, 
                    cargoWeight, loadFactor, segmentFuel)
       END FOR
       
       RETURN totalFuel
   }
   
   // Helper: XÃ¡c Ä‘á»‹nh trá»ng lÆ°á»£ng hÃ ng cho tá»«ng loáº¡i segment
   determineCargoWeightForSegment(segment, segmentType, orderDetails) {
       SWITCH segmentType:
           CASE "PICKUP":
               // Äang Ä‘i láº¥y hÃ ng â†’ xe cÃ³ thá»ƒ Ä‘Ã£ cÃ³ hÃ ng trÆ°á»›c Ä‘Ã³
               RETURN calculatePartialLoad(orderDetails, segment)
               
           CASE "DELIVERY":
               // Äang giao hÃ ng â†’ xe chá»Ÿ Ä‘áº§y
               RETURN SUM(orderDetails.filter(od -> od.status = "IN_TRANSIT").weight)
               
           CASE "RETURN":
           CASE "RETURN_TO_ORIGIN":
               // Quay vá» â†’ xe rá»—ng hoáº·c chá»Ÿ hÃ ng tráº£ láº¡i
               returnedDetails = orderDetails.filter(od -> od.status = "RETURNED")
               RETURN SUM(returnedDetails.weight) ?? 0
               
           DEFAULT:
               RETURN 0
       END SWITCH
   }

   BÆ¯á»šC 4: Cáº¬P NHáº¬T TRáº NG THÃI CASCADE
   
   â±ï¸ Xá»¬ LÃ: Äá»’NG Bá»˜ (Synchronous) trong cÃ¹ng Transaction
   ğŸ”’ TRANSACTION: @Transactional Ä‘áº£m báº£o atomicity
   
   updateRelatedStatuses(fuelEntity) {
       vehicleAssignment = fuelEntity.vehicleAssignment
       orderId = vehicleAssignment.orderDetails[0].order.id
       
       // STEP 1: Cáº­p nháº­t táº¥t cáº£ OrderDetail â†’ DELIVERED
       FOR each orderDetail IN vehicleAssignment.orderDetails:
           IF orderDetail.status NOT IN ["RETURNED", "CANCELLED"] THEN
               orderDetail.status = "DELIVERED"
               save(orderDetail)
               
               // âš¡ ASYNC: WebSocket notification (Fire-and-forget)
               orderDetailStatusWebSocketService.notifyStatusChange(orderDetail)
           END IF
       END FOR
       
       // STEP 2: Kiá»ƒm tra táº¥t cáº£ assignments Ä‘Ã£ hoÃ n thÃ nh chÆ°a
       allAssignments = findAllByOrderId(orderId)
       
       allCompleted = allAssignments.stream().allMatch(assignment -> {
           fuelRecord = findByVehicleAssignmentId(assignment.id)
           RETURN fuelRecord.isPresent AND fuelRecord.odometerReadingAtEnd != NULL
       })
       
       // STEP 3: Náº¿u táº¥t cáº£ hoÃ n thÃ nh â†’ Order â†’ SUCCESSFUL
       IF allCompleted THEN
           order = findOrderById(orderId)
           order.status = OrderStatusEnum.SUCCESSFUL
           save(order)
           
           LOG.info("âœ… Order {} marked as SUCCESSFUL - all fuel records complete", orderId)
           
           // âš¡ ASYNC: WebSocket notification
           orderStatusWebSocketService.notifyStatusChange(order)
       END IF
       
       // STEP 4: Cáº­p nháº­t Vehicle â†’ AVAILABLE
       vehicle = vehicleAssignment.vehicle
       vehicle.status = VehicleStatusEnum.AVAILABLE
       save(vehicle)
   }

   BÆ¯á»šC 5: UPLOAD HÃ“A ÄÆ N NHIÃŠN LIá»†U (TÃ™Y CHá»ŒN)
   
   â±ï¸ Xá»¬ LÃ: Äá»’NG Bá»˜ (Synchronous)
   ğŸ“ Má»¤C ÄÃCH: Äá»‘i soÃ¡t chi phÃ­ vá»›i cÃ´ng ty nhiÃªn liá»‡u
   
   updateInvoiceImage(request) {
       entity = findById(request.fuelConsumptionId)
       
       // Upload áº£nh hÃ³a Ä‘Æ¡n
       invoiceUrl = cloudinaryService.uploadImage(
           request.companyInvoiceImage,
           "vehicle-fuel/invoices"
       )
       
       entity.companyInvoiceImageUrl = invoiceUrl
       entity.notes = request.notes
       save(entity)
       
       RETURN mapToResponse(entity)
   }

ğŸ” ÄIá»‚M Äáº¶C BIá»†T:

   âœ… Validation cháº·t cháº½:
   â€¢ Khoáº£ng cÃ¡ch: 0 < distance â‰¤ 10,000 km
   â€¢ Fuel volume: 0 < fuel â‰¤ 10,000 lÃ­t
   â€¢ Sá»‘ km káº¿t thÃºc > sá»‘ km báº¯t Ä‘áº§u

   âœ… Load Factor thÃ´ng minh:
   â€¢ Dá»±a trÃªn % táº£i trá»ng thá»±c táº¿
   â€¢ Range: 1.0 (xe rá»—ng) â†’ 1.25 (quÃ¡ táº£i)
   â€¢ TÃ­nh riÃªng cho tá»«ng segment (náº¿u dÃ¹ng segment-based)

   âœ… Fallback mechanism:
   â€¢ Æ¯u tiÃªn: Odometer-based (chÃ­nh xÃ¡c hÆ¡n)
   â€¢ Fallback: Segment-based (náº¿u thiáº¿u dá»¯ liá»‡u)
   â€¢ Final fallback: CÃ´ng thá»©c Ä‘Æ¡n giáº£n (distance Ã— baseFuel / 100)

   âœ… Transaction safety:
   â€¢ @Transactional Ä‘áº£m báº£o atomicity
   â€¢ Rollback náº¿u cÃ³ lá»—i trong quÃ¡ trÃ¬nh update

   âœ… Status cascade:
   â€¢ OrderDetail â†’ DELIVERED
   â€¢ Order â†’ SUCCESSFUL (khi táº¥t cáº£ assignments hoÃ n thÃ nh)
   â€¢ Vehicle â†’ AVAILABLE

ğŸ¯ OUTPUT: VehicleFuelConsumptionResponse vá»›i:
   â€¢ id, vehicleAssignmentId
   â€¢ odometerReadingAtStart, odometerReadingAtEnd
   â€¢ distanceTraveled (km)
   â€¢ fuelVolume (lÃ­t)
   â€¢ odometerAtStartUrl, odometerAtEndUrl
   â€¢ companyInvoiceImageUrl (náº¿u cÃ³)
   â€¢ dateRecorded, notes


================================================================================
8. Xá»¬ LÃ Äá»’NG Bá»˜/Báº¤T Äá»’NG Bá»˜ & ÄÆ N LUá»’NG/ÄA LUá»’NG
================================================================================

ğŸ“Œ Má»¤C ÄÃCH:
   LÃ m rÃµ cÃ¡ch há»‡ thá»‘ng xá»­ lÃ½ cÃ¡c tÃ¡c vá»¥ theo tá»«ng phÆ°Æ¡ng thá»©c,
   Ä‘áº£m báº£o hiá»‡u nÄƒng vÃ  tÃ­nh nháº¥t quÃ¡n dá»¯ liá»‡u.

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Tá»”NG QUAN KIáº¾N TRÃšC Xá»¬ LÃ                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚   â”‚   HTTP      â”‚â”€â”€â”€â”€â–¶â”‚   Service   â”‚â”€â”€â”€â”€â–¶â”‚  Database   â”‚                   â”‚
â”‚   â”‚   Request   â”‚     â”‚   Layer     â”‚     â”‚  (MySQL)    â”‚                   â”‚
â”‚   â”‚  (Spring)   â”‚â—€â”€â”€â”€â”€â”‚  @Service   â”‚â—€â”€â”€â”€â”€â”‚  @Transact  â”‚                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚         â”‚                   â”‚                                                â”‚
â”‚         â”‚                   â–¼                                                â”‚
â”‚         â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚         â”‚         â”‚  Cloudinary â”‚     â”‚  WebSocket  â”‚                       â”‚
â”‚         â”‚         â”‚  (Upload)   â”‚     â”‚  (Real-time)â”‚                       â”‚
â”‚         â”‚         â”‚   SYNC      â”‚     â”‚   ASYNC     â”‚                       â”‚
â”‚         â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚         â”‚                                    â”‚                               â”‚
â”‚         â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚         â”‚                   â–¼                â–¼               â–¼              â”‚
â”‚         â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚         â”‚         â”‚  Scheduled  â”‚  â”‚  Firebase   â”‚  â”‚  Mobile     â”‚        â”‚
â”‚         â”‚         â”‚  Tasks      â”‚  â”‚  Push       â”‚  â”‚  Clients    â”‚        â”‚
â”‚         â”‚         â”‚  (Cron)     â”‚  â”‚  (ASYNC)    â”‚  â”‚             â”‚        â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â–¶â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
8.1. PHÃ‚N LOáº I Xá»¬ LÃ Äá»’NG Bá»˜ (SYNCHRONOUS)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ Äá»ŠNH NGHÄ¨A:
   â€¢ Request chá» Ä‘á»£i response trÆ°á»›c khi tiáº¿p tá»¥c
   â€¢ Blocking I/O: Thread bá»‹ block cho Ä‘áº¿n khi hoÃ n thÃ nh
   â€¢ Äáº£m báº£o tÃ­nh nháº¥t quÃ¡n dá»¯ liá»‡u (ACID)

ğŸ“‹ CÃC TÃC Vá»¤ Xá»¬ LÃ Äá»’NG Bá»˜:

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ TÃC Vá»¤                          â”‚ LÃ DO Äá»’NG Bá»˜                        â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ Database CRUD operations        â”‚ Äáº£m báº£o ACID, data integrity         â”‚
   â”‚ Cloudinary image upload         â”‚ Cáº§n URL ngay Ä‘á»ƒ lÆ°u DB               â”‚
   â”‚ Price calculation               â”‚ Response cáº§n káº¿t quáº£ ngay            â”‚
   â”‚ BinPacker algorithm             â”‚ TÃ­nh toÃ¡n CPU-bound, cáº§n káº¿t quáº£     â”‚
   â”‚ Driver assignment scoring       â”‚ Response cáº§n danh sÃ¡ch gá»£i Ã½         â”‚
   â”‚ Contract creation               â”‚ Transaction phá»©c táº¡p, nhiá»u báº£ng     â”‚
   â”‚ Order status update             â”‚ Cáº§n confirm trÆ°á»›c khi tiáº¿p tá»¥c       â”‚
   â”‚ Payment validation              â”‚ Critical path, khÃ´ng Ä‘Æ°á»£c lá»—i        â”‚
   â”‚ Authentication/Authorization    â”‚ Security, cáº§n verify trÆ°á»›c khi cho   â”‚
   â”‚ Fuel consumption calculation    â”‚ Cáº§n káº¿t quáº£ ngay Ä‘á»ƒ update status    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“‹ PATTERN Sá»¬ Dá»¤NG:

   1. DATABASE TRANSACTION (Spring @Transactional):
   
   @Service
   @Transactional  // <-- Äáº£m báº£o atomic operation
   public class OrderServiceImpl {
       
       public OrderResponse createOrder(OrderRequest request) {
           // âš¡ SYNC: Táº¥t cáº£ operations trong 1 transaction
           Order order = saveOrder(request);
           OrderDetails details = saveOrderDetails(order, request.details);
           Contract contract = createContract(order);
           
           // Náº¿u 1 bÆ°á»›c lá»—i â†’ rollback toÃ n bá»™
           return mapToResponse(order);
       }
   }

   2. BLOCKING I/O (Cloudinary upload):
   
   public String uploadImage(MultipartFile file, String folder) {
       // âš¡ SYNC: Thread blocked until upload completes
       // Timeout: 30 seconds
       Map result = cloudinary.uploader().upload(file.getBytes(), 
           ObjectUtils.asMap("folder", folder));
       
       return (String) result.get("secure_url");
   }

   3. CPU-BOUND CALCULATION (BinPacker):
   
   public List<ContractRuleAssignResponse> assignVehiclesOptimal(UUID orderId) {
       // âš¡ SYNC: CPU-intensive, single-threaded
       // Complexity: O(n Ã— m Ã— r) vá»›i n=items, m=bins, r=rotations
       
       List<BoxItem> items = prepareBoxItems(orderId);
       List<SizeRule> bins = getAvailableSizeRules();
       
       // Thuáº­t toÃ¡n 3D bin packing
       return binPacker.pack(items, bins);  // Blocking
   }

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
8.2. PHÃ‚N LOáº I Xá»¬ LÃ Báº¤T Äá»’NG Bá»˜ (ASYNCHRONOUS)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ Äá»ŠNH NGHÄ¨A:
   â€¢ Request khÃ´ng chá» Ä‘á»£i káº¿t quáº£
   â€¢ Non-blocking: Thread Ä‘Æ°á»£c giáº£i phÃ³ng ngay
   â€¢ PhÃ¹ há»£p cho I/O-bound tasks, notifications

ğŸ“‹ CÃC TÃC Vá»¤ Xá»¬ LÃ Báº¤T Äá»’NG Bá»˜:

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ TÃC Vá»¤                          â”‚ IMPLEMENTATION                       â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ WebSocket notifications         â”‚ SimpMessagingTemplate (Fire-forget)  â”‚
   â”‚ Firebase push notifications     â”‚ @Async + CompletableFuture           â”‚
   â”‚ Email sending                   â”‚ @Async + Queue                       â”‚
   â”‚ Off-route event monitoring      â”‚ @Scheduled (1 minute interval)       â”‚
   â”‚ Payment deadline checking       â”‚ @Scheduled (hourly)                  â”‚
   â”‚ GPS location processing         â”‚ WebSocket receive (non-blocking)     â”‚
   â”‚ Audit logging                   â”‚ @Async (background logging)          â”‚
   â”‚ Report generation               â”‚ @Async + callback                    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“‹ PATTERN Sá»¬ Dá»¤NG:

   1. WEBSOCKET NOTIFICATIONS (Fire-and-forget):
   
   @Service
   public class OrderStatusWebSocketService {
       @Autowired
       private SimpMessagingTemplate messagingTemplate;
       
       public void notifyStatusChange(Order order) {
           // âš¡ ASYNC: Non-blocking, gá»­i vÃ  quÃªn
           // KhÃ´ng chá» client nháº­n Ä‘Æ°á»£c
           messagingTemplate.convertAndSend(
               "/topic/orders/" + order.getId(),
               new OrderStatusEvent(order.getStatus())
           );
       }
   }

   2. FIREBASE PUSH NOTIFICATION (@Async):
   
   @Service
   public class NotificationService {
       
       @Async("asyncExecutor")  // <-- Cháº¡y trÃªn thread pool riÃªng
       public CompletableFuture<Void> sendPushNotification(
           String deviceToken, String title, String body
       ) {
           // âš¡ ASYNC: Cháº¡y background, khÃ´ng block main thread
           Message message = Message.builder()
               .setToken(deviceToken)
               .setNotification(Notification.builder()
                   .setTitle(title)
                   .setBody(body)
                   .build())
               .build();
           
           FirebaseMessaging.getInstance().sendAsync(message);
           return CompletableFuture.completedFuture(null);
       }
   }

   3. SCHEDULED TASKS (@Scheduled):
   
   @Service
   public class OffRouteMonitoringJob {
       
       @Scheduled(cron = "0 * * * * *")  // Every 1 minute
       public void checkActiveOffRouteEvents() {
           // âš¡ ASYNC: Cháº¡y Ä‘á»‹nh ká»³ trÃªn thread riÃªng
           List<OffRouteEvent> events = findAllActiveEvents();
           
           for (OffRouteEvent event : events) {
               checkWarningThresholds(event);  // Check vÃ  gá»­i cáº£nh bÃ¡o
           }
       }
       
       @Scheduled(cron = "0 0 * * * *")  // Every hour
       public void checkPaymentDeadlines() {
           // âš¡ ASYNC: Check cÃ¡c payment quÃ¡ háº¡n
           List<Transaction> overduePayments = findOverduePayments();
           processOverduePayments(overduePayments);
       }
   }

   4. GPS LOCATION PROCESSING (WebSocket receive):
   
   @Controller
   public class LocationWebSocketController {
       
       @MessageMapping("/location-update")
       public void handleLocationUpdate(LocationUpdateMessage message) {
           // âš¡ ASYNC: Nháº­n tá»« WebSocket, xá»­ lÃ½ background
           // KhÃ´ng block client
           
           offRouteService.processLocationUpdate(
               message.getVehicleAssignmentId(),
               message.getLat(),
               message.getLng(),
               message.getSpeed(),
               message.getBearing()
           );
       }
   }

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
8.3. Xá»¬ LÃ ÄÆ N LUá»’NG (SINGLE-THREADED)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ Äá»ŠNH NGHÄ¨A:
   â€¢ Má»™t thread xá»­ lÃ½ má»™t request tá»« Ä‘áº§u Ä‘áº¿n cuá»‘i
   â€¢ KhÃ´ng cÃ³ race condition
   â€¢ ÄÆ¡n giáº£n, dá»… debug

ğŸ“‹ CÃC TÃC Vá»¤ ÄÆ N LUá»’NG:

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ TÃC Vá»¤                          â”‚ LÃ DO ÄÆ N LUá»’NG                      â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ HTTP Request handling           â”‚ 1 thread/request (Tomcat)            â”‚
   â”‚ Database transaction            â”‚ Connection per thread                â”‚
   â”‚ BinPacker algorithm             â”‚ Stateful, sequential                 â”‚
   â”‚ Price calculation               â”‚ Sequential steps                     â”‚
   â”‚ Contract PDF generation         â”‚ Sequential rendering                 â”‚
   â”‚ Compensation calculation        â”‚ Business logic sequence              â”‚
   â”‚ Fuel consumption calculation    â”‚ Step-by-step calculation             â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“‹ SPRING MVC THREAD MODEL:

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                                                                      â”‚
   â”‚   Client Request                                                     â”‚
   â”‚        â”‚                                                             â”‚
   â”‚        â–¼                                                             â”‚
   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
   â”‚   â”‚ Tomcat Thread   â”‚  â† Láº¥y 1 thread tá»« pool (default: 200)       â”‚
   â”‚   â”‚ Pool            â”‚                                               â”‚
   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
   â”‚            â”‚                                                         â”‚
   â”‚            â–¼                                                         â”‚
   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
   â”‚   â”‚ DispatcherServletâ”‚                                              â”‚
   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
   â”‚            â”‚                                                         â”‚
   â”‚            â–¼                                                         â”‚
   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
   â”‚   â”‚ Controller      â”‚â”€â”€â”€â–¶â”‚ Service         â”‚                        â”‚
   â”‚   â”‚ @RestController â”‚    â”‚ @Service        â”‚                        â”‚
   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
   â”‚                                   â”‚                                  â”‚
   â”‚                                   â–¼                                  â”‚
   â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
   â”‚                          â”‚ Repository      â”‚                        â”‚
   â”‚                          â”‚ @Repository     â”‚                        â”‚
   â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
   â”‚                                   â”‚                                  â”‚
   â”‚                                   â–¼                                  â”‚
   â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
   â”‚                          â”‚ Database        â”‚                        â”‚
   â”‚                          â”‚ Connection      â”‚                        â”‚
   â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
   â”‚                                                                      â”‚
   â”‚   ğŸ”‘ Táº¤T Cáº¢ CHáº Y TRÃŠN CÃ™NG 1 THREAD!                                â”‚
   â”‚                                                                      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
8.4. Xá»¬ LÃ ÄA LUá»’NG (MULTI-THREADED)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ Äá»ŠNH NGHÄ¨A:
   â€¢ Nhiá»u thread xá»­ lÃ½ song song
   â€¢ TÄƒng throughput, táº­n dá»¥ng CPU Ä‘a nhÃ¢n
   â€¢ Cáº§n chÃº Ã½ thread-safety, race condition

ğŸ“‹ CÃC TÃC Vá»¤ ÄA LUá»’NG:

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ TÃC Vá»¤                          â”‚ THREAD POOL                          â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ HTTP Request handling           â”‚ Tomcat Thread Pool (200 threads)     â”‚
   â”‚ @Async methods                  â”‚ Custom ThreadPoolTaskExecutor        â”‚
   â”‚ @Scheduled jobs                 â”‚ ScheduledThreadPoolExecutor          â”‚
   â”‚ WebSocket connections           â”‚ Netty Event Loop (if used)           â”‚
   â”‚ Parallel stream processing      â”‚ ForkJoinPool.commonPool()            â”‚
   â”‚ CompletableFuture               â”‚ Custom executor                      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“‹ Cáº¤U HÃŒNH THREAD POOL:

   @Configuration
   @EnableAsync
   public class AsyncConfig {
       
       @Bean("asyncExecutor")
       public Executor asyncExecutor() {
           ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
           
           executor.setCorePoolSize(5);        // Sá»‘ thread tá»‘i thiá»ƒu
           executor.setMaxPoolSize(20);        // Sá»‘ thread tá»‘i Ä‘a
           executor.setQueueCapacity(100);     // HÃ ng Ä‘á»£i chá» xá»­ lÃ½
           executor.setThreadNamePrefix("Async-");
           executor.setRejectedExecutionHandler(
               new ThreadPoolExecutor.CallerRunsPolicy()  // Fallback
           );
           executor.initialize();
           
           return executor;
       }
       
       @Bean("scheduledExecutor")
       public TaskScheduler taskScheduler() {
           ThreadPoolTaskScheduler scheduler = new ThreadPoolTaskScheduler();
           scheduler.setPoolSize(5);
           scheduler.setThreadNamePrefix("Scheduled-");
           return scheduler;
       }
   }

ğŸ“‹ Xá»¬ LÃ CONCURRENT ACCESS:

   1. PESSIMISTIC LOCKING (Database level):
   
   @Lock(LockModeType.PESSIMISTIC_WRITE)
   @Query("SELECT v FROM VehicleEntity v WHERE v.id = :id")
   Optional<VehicleEntity> findByIdWithLock(@Param("id") UUID id);
   
   // Sá»­ dá»¥ng khi update vehicle status
   public void updateVehicleStatus(UUID vehicleId, String newStatus) {
       VehicleEntity vehicle = vehicleRepository.findByIdWithLock(vehicleId)
           .orElseThrow(() -> new NotFoundException("Vehicle not found"));
       
       vehicle.setStatus(newStatus);
       vehicleRepository.save(vehicle);
   }

   2. OPTIMISTIC LOCKING (@Version):
   
   @Entity
   public class OrderEntity {
       @Version
       private Long version;  // Auto-increment on update
       
       // Náº¿u 2 thread update cÃ¹ng lÃºc â†’ OptimisticLockException
   }

   3. THREAD-SAFE COLLECTIONS:
   
   // Cho off-route event tracking
   private final ConcurrentHashMap<UUID, OffRouteEvent> activeEvents 
       = new ConcurrentHashMap<>();
   
   public void trackEvent(UUID vehicleAssignmentId, OffRouteEvent event) {
       activeEvents.put(vehicleAssignmentId, event);
   }

   4. SYNCHRONIZED METHODS:
   
   // Cho driver assignment scoring (trÃ¡nh assign duplicate)
   public synchronized List<DriverSuggestion> getDriverSuggestions(
       UUID vehicleId, LocalDate tripDate
   ) {
       // Äáº£m báº£o chá»‰ 1 thread tÃ­nh Ä‘iá»ƒm táº¡i 1 thá»i Ä‘iá»ƒm
       return calculateDriverScores(vehicleId, tripDate);
   }

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
8.5. MA TRáº¬N Tá»”NG Há»¢P THEO Tá»ªNG NGHIá»†P Vá»¤
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NGHIá»†P Vá»¤              â”‚ SYNC/    â”‚ SINGLE/      â”‚ GHI CHÃš                    â”‚
â”‚                        â”‚ ASYNC    â”‚ MULTI        â”‚                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. BinPacker           â”‚ SYNC     â”‚ SINGLE       â”‚ CPU-bound, sequential      â”‚
â”‚    - Prepare data      â”‚ SYNC     â”‚ SINGLE       â”‚ DB read                    â”‚
â”‚    - Pack algorithm    â”‚ SYNC     â”‚ SINGLE       â”‚ Complex calculation        â”‚
â”‚    - Return result     â”‚ SYNC     â”‚ SINGLE       â”‚ Response to client         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2. Pricing             â”‚ SYNC     â”‚ SINGLE       â”‚ Sequential calculation     â”‚
â”‚    - Base price        â”‚ SYNC     â”‚ SINGLE       â”‚ Lookup basing_price        â”‚
â”‚    - Surcharges        â”‚ SYNC     â”‚ SINGLE       â”‚ Formula calculation        â”‚
â”‚    - Total             â”‚ SYNC     â”‚ SINGLE       â”‚ Sum all components         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3. Driver Assignment   â”‚ SYNC     â”‚ SINGLE       â”‚ Scoring algorithm          â”‚
â”‚    - Filter drivers    â”‚ SYNC     â”‚ SINGLE       â”‚ DB query                   â”‚
â”‚    - Calculate scores  â”‚ SYNC     â”‚ SINGLE       â”‚ Multi-factor scoring       â”‚
â”‚    - Sort & select     â”‚ SYNC     â”‚ SINGLE       â”‚ Top-N selection            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 4. Return Shipping     â”‚ SYNC     â”‚ SINGLE       â”‚ Transaction-based          â”‚
â”‚    - Calculate fee     â”‚ SYNC     â”‚ SINGLE       â”‚ Reuse pricing logic        â”‚
â”‚    - Create transactionâ”‚ SYNC     â”‚ SINGLE       â”‚ DB write                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 5. Compensation        â”‚ SYNC     â”‚ SINGLE       â”‚ Complex business logic     â”‚
â”‚    - Assessment        â”‚ SYNC     â”‚ SINGLE       â”‚ Staff input                â”‚
â”‚    - Calculation       â”‚ SYNC     â”‚ SINGLE       â”‚ 4 cases logic              â”‚
â”‚    - Create refund     â”‚ SYNC     â”‚ SINGLE       â”‚ Transaction                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 6. Off-Route Detection â”‚ MIXED    â”‚ MIXED        â”‚ Real-time monitoring       â”‚
â”‚    - GPS receive       â”‚ ASYNC    â”‚ MULTI        â”‚ WebSocket (concurrent)     â”‚
â”‚    - Distance calc     â”‚ SYNC     â”‚ SINGLE       â”‚ Haversine formula          â”‚
â”‚    - Warning send      â”‚ ASYNC    â”‚ MULTI        â”‚ WebSocket broadcast        â”‚
â”‚    - Scheduled check   â”‚ ASYNC    â”‚ SINGLE       â”‚ @Scheduled (1 min)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 7. Fuel Consumption    â”‚ SYNC     â”‚ SINGLE       â”‚ Transaction-based          â”‚
â”‚    - Upload image      â”‚ SYNC     â”‚ SINGLE       â”‚ Cloudinary blocking        â”‚
â”‚    - Calculate fuel    â”‚ SYNC     â”‚ SINGLE       â”‚ Formula calculation        â”‚
â”‚    - Update statuses   â”‚ SYNC     â”‚ SINGLE       â”‚ Cascade updates            â”‚
â”‚    - WebSocket notify  â”‚ ASYNC    â”‚ MULTI        â”‚ Fire-and-forget            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ CROSS-CUTTING          â”‚          â”‚              â”‚                            â”‚
â”‚    - HTTP Requests     â”‚ SYNC     â”‚ MULTI        â”‚ Tomcat thread pool (200)   â”‚
â”‚    - DB Transactions   â”‚ SYNC     â”‚ SINGLE       â”‚ 1 connection/thread        â”‚
â”‚    - WebSocket out     â”‚ ASYNC    â”‚ MULTI        â”‚ Fire-and-forget            â”‚
â”‚    - Push notification â”‚ ASYNC    â”‚ MULTI        â”‚ @Async thread pool         â”‚
â”‚    - Scheduled jobs    â”‚ ASYNC    â”‚ SINGLE       â”‚ 1 job = 1 thread           â”‚
â”‚    - Audit logging     â”‚ ASYNC    â”‚ MULTI        â”‚ Background logging         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
8.6. BEST PRACTICES & PITFALLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… BEST PRACTICES:

   1. Transaction Management:
      â€¢ Giá»¯ transaction ngáº¯n gá»n
      â€¢ KhÃ´ng gá»i external API trong transaction
      â€¢ Sá»­ dá»¥ng @Transactional(readOnly = true) cho read-only operations

   2. Async Processing:
      â€¢ Sá»­ dá»¥ng @Async cho I/O-bound tasks (email, push notification)
      â€¢ Cáº¥u hÃ¬nh thread pool phÃ¹ há»£p vá»›i workload
      â€¢ Xá»­ lÃ½ exception trong async methods

   3. Concurrency Control:
      â€¢ Sá»­ dá»¥ng optimistic locking cho high-contention entities
      â€¢ Pessimistic locking cho critical updates (payment, status)
      â€¢ Avoid deadlocks: lock theo thá»© tá»± nháº¥t Ä‘á»‹nh

   4. WebSocket:
      â€¢ Fire-and-forget cho notifications
      â€¢ KhÃ´ng chá» ACK tá»« client
      â€¢ Retry mechanism á»Ÿ client side

âŒ PITFALLS TO AVOID:

   1. N+1 Query Problem:
      â€¢ Sá»­ dá»¥ng @EntityGraph hoáº·c JOIN FETCH
      â€¢ Batch fetching cho collections

   2. Long-running Transactions:
      â€¢ TÃ¡ch upload áº£nh ra khá»i main transaction
      â€¢ Sá»­ dá»¥ng saga pattern cho distributed transactions

   3. Thread Starvation:
      â€¢ KhÃ´ng block async thread pool vá»›i sync operations
      â€¢ Monitor thread pool metrics

   4. Race Conditions:
      â€¢ Double-check locking cho singleton operations
      â€¢ Sá»­ dá»¥ng database constraints (unique, check)


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                              Káº¾T LUáº¬N                                         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Há»‡ thá»‘ng Truckie triá»ƒn khai 7 luá»“ng nghiá»‡p vá»¥ phá»©c táº¡p vá»›i logic cháº·t cháº½:

1. BinPacker: Tá»‘i Æ°u 3D bin packing vá»›i 3 chiáº¿n lÆ°á»£c thÃ´ng minh
   â†’ SYNC + SINGLE-THREADED (CPU-bound, sequential algorithm)

2. Pricing: CÃ´ng thá»©c tÃ­nh giÃ¡ linh hoáº¡t vá»›i nhiá»u phá»¥ phÃ­
   â†’ SYNC + SINGLE-THREADED (Sequential calculation)

3. Driver Assignment: Cháº¥m Ä‘iá»ƒm Ä‘a yáº¿u tá»‘, cÃ¢n báº±ng workload
   â†’ SYNC + SINGLE-THREADED (Scoring algorithm)

4. Return Shipping: TÃ­nh cÆ°á»›c tráº£ hÃ ng chÃ­nh xÃ¡c theo tá»«ng kiá»‡n
   â†’ SYNC + SINGLE-THREADED (Transaction-based)

5. Compensation: 4 cases bá»“i thÆ°á»ng rÃµ rÃ ng, phÃ¡t hiá»‡n gian láº­n
   â†’ SYNC + SINGLE-THREADED (Complex business logic)

6. Off-route: 3-tier warning, grace period, auto issue creation
   â†’ MIXED: GPS receive (ASYNC/MULTI), Calculation (SYNC/SINGLE), 
     Warning send (ASYNC/MULTI), Scheduled check (ASYNC/SINGLE)

7. Fuel Consumption: Odometer-first vá»›i load factor thÃ´ng minh
   â†’ SYNC + SINGLE-THREADED (Calculation + Transaction)
   â†’ ASYNC cho WebSocket notifications

Táº¥t cáº£ Ä‘á»u cÃ³:
â€¢ Validation cháº·t cháº½
â€¢ Error handling Ä‘áº§y Ä‘á»§
â€¢ Audit trail chi tiáº¿t
â€¢ Transaction safety vá»›i @Transactional
â€¢ Thread-safe cho concurrent access
