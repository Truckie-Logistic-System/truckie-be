â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    TÃ“M Táº®T LOGIC CÃC LUá»’NG NGHIá»†P Vá»¤ CHÃNH                   â•‘
â•‘                  Há»† THá»NG QUáº¢N LÃ Váº¬N CHUYá»‚N - TRUCKIE                       â•‘
â•‘                              PHáº¦N 2/2                                         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

================================================================================
5. NGHIá»†P Vá»¤ Xá»¬ LÃ Bá»’I THÆ¯á»œNG (COMPENSATION)
================================================================================

ğŸ“Œ Má»¤C ÄÃCH:
   Xá»­ lÃ½ bá»“i thÆ°á»ng khi hÃ ng hÃ³a bá»‹ hÆ° há»ng/máº¥t mÃ¡t trong quÃ¡ trÃ¬nh váº­n chuyá»ƒn.

ğŸ“‹ CÆ  CHáº¾ HOáº T Äá»˜NG:

   BÆ¯á»šC 1: STAFF THáº¨M Äá»ŠNH
   
   1.1. ThÃ´ng tin hÃ ng hÃ³a
   â€¢ hasDocuments: cÃ³ chá»©ng tá»« há»£p lá»‡? (hÃ³a Ä‘Æ¡n, bill...)
   â€¢ documentValue: giÃ¡ trá»‹ ghi trÃªn chá»©ng tá»«
   â€¢ estimatedMarketValue: giÃ¡ Æ°á»›c tÃ­nh náº¿u khÃ´ng cÃ³ chá»©ng tá»«
   â€¢ documentImages: áº£nh chá»©ng tá»« (upload Cloudinary)
   
   1.2. Má»©c Ä‘á»™ hÆ° há»ng
   â€¢ assessmentRatePercent: % hÆ° há»ng (0-100%)
     - 50% = há»ng má»™t ná»­a
     - 100% = há»ng toÃ n bá»™/máº¥t hÃ ng
   
   1.3. PhÃ¡t hiá»‡n gian láº­n
   IF fraudDetected = TRUE THEN
       â†’ Ban account customer (status = BANNED)
       â†’ Issue.status = CLOSED_FRAUD
       â†’ KHÃ”NG bá»“i thÆ°á»ng
   END IF

   BÆ¯á»šC 2: TÃNH Bá»’I THÆ¯á»œNG HÃ€NG HÆ¯ Há»NG (DAMAGE)
   
   KÃ­ hiá»‡u:
   â€¢ V_thá»±c_táº¿: GiÃ¡ trá»‹ thá»±c táº¿ hÃ ng
   â€¢ V_khai_bÃ¡o: declaredValue
   â€¢ V_chá»©ng_tá»«: documentValue
   â€¢ T_hÆ°: assessmentRate (0.0-1.0)
   â€¢ C_total: tá»•ng cÆ°á»›c
   â€¢ W_kiá»‡n: trá»ng lÆ°á»£ng kiá»‡n hÆ°
   â€¢ W_total: tá»•ng trá»ng lÆ°á»£ng
   
   2.1. XÃ¡c Ä‘á»‹nh V_thá»±c_táº¿
   
   IF hasDocuments = TRUE AND documentValue > 0 THEN
       IF documentValue < declaredValue THEN
           V_thá»±c_táº¿ = documentValue
           Note = "CT < KB: Äá»n theo CT"
       ELSE IF documentValue = declaredValue THEN
           V_thá»±c_táº¿ = documentValue
           Note = "CT = KB: Khá»›p hoÃ n toÃ n"
       ELSE  // documentValue > declaredValue
           V_thá»±c_táº¿ = declaredValue
           Note = "CT > KB: Äá»n tá»‘i Ä‘a theo KB (Under-insured)"
       END IF
   ELSE
       IF estimatedMarketValue > 0 THEN
           V_thá»±c_táº¿ = estimatedMarketValue
           Note = "KhÃ´ng CT: DÃ¹ng giÃ¡ Æ°á»›c tÃ­nh"
       ELSE
           V_thá»±c_táº¿ = declaredValue
           Note = "KhÃ´ng CT: DÃ¹ng KB"
       END IF
   END IF
   
   2.2. TÃ­nh C_hÆ° (cÆ°á»›c váº­n chuyá»ƒn tá»· lá»‡)
   
   weightRatio = W_kiá»‡n / W_total
   freightRefund = C_total Ã— weightRatio Ã— T_hÆ°
   
   VÃ­ dá»¥:
   â€¢ CÆ°á»›c 1,000,000 VNÄ
   â€¢ Kiá»‡n hÆ° 0.5 táº¥n / Tá»•ng 2 táº¥n = 25%
   â€¢ HÆ° 50%
   â†’ C_hÆ° = 1,000,000 Ã— 0.25 Ã— 0.5 = 125,000 VNÄ
   
   2.3. TÃ­nh V_lá»— (giÃ¡ trá»‹ máº¥t mÃ¡t)
   
   valueLoss = V_thá»±c_táº¿ Ã— T_hÆ°
   
   2.4. TÃ­nh B_hÃ ng (bá»“i thÆ°á»ng hÃ ng hÃ³a)
   
   legalLimit = C_total Ã— 10  // Giá»›i háº¡n phÃ¡p luáº­t: 10Ã— cÆ°á»›c
   
   CASE 1: CÃ³ BH + CÃ³ CT â†’ KhÃ´ng giá»›i háº¡n
   IF hasInsurance = TRUE AND hasDocuments = TRUE THEN
       goodsCompensation = MIN(valueLoss, declaredValue)
   
   CASE 2: CÃ³ BH + KhÃ´ng CT â†’ BH vÃ´ hiá»‡u, Ã¡p dá»¥ng 10Ã—
   ELSE IF hasInsurance = TRUE AND hasDocuments = FALSE THEN
       goodsCompensation = MIN(valueLoss, legalLimit)
   
   CASE 3: KhÃ´ng BH + CÃ³ CT â†’ Ãp dá»¥ng 10Ã—
   ELSE IF hasInsurance = FALSE AND hasDocuments = TRUE THEN
       goodsCompensation = MIN(valueLoss, legalLimit)
   
   CASE 4: KhÃ´ng BH + KhÃ´ng CT â†’ Ãp dá»¥ng 10Ã—
   ELSE
       goodsCompensation = MIN(valueLoss, legalLimit)
   END IF
   
   2.5. TÃ­nh B_tá»•ng
   
   totalCompensation = goodsCompensation + freightRefund
   
   // Fix CASE 2: Cap tá»•ng á»Ÿ legal limit
   IF hasInsurance = TRUE AND hasDocuments = FALSE THEN
       IF totalCompensation > legalLimit THEN
           totalCompensation = legalLimit
       END IF
   END IF

   BÆ¯á»šC 3: TÃNH Bá»’I THÆ¯á»œNG Lá»†CH TUYáº¾N (OFF_ROUTE)
   
   Äáº·c Ä‘iá»ƒm:
   â€¢ T_hÆ° = 100% (coi nhÆ° máº¥t hÃ ng)
   â€¢ KHÃ”NG giá»›i háº¡n 10Ã— (lá»—i cá»‘ Ã½)
   â€¢ B_hÃ ng = 100% V_thá»±c_táº¿
   â€¢ C_hÆ° = 100% C_total
   
   totalCompensation = V_thá»±c_táº¿ + C_total

   BÆ¯á»šC 4: Táº O REFUND
   
   Náº¿u Staff chá»n "Táº¡o refund":
   
   refund = {
       issueId, refundAmount: finalCompensation,
       bankName, accountNumber, accountHolderName,
       transactionCode, bankTransferImage, notes,
       refundDate: NOW, processedByStaff
   }

   BÆ¯á»šC 5: Cáº¬P NHáº¬T TRáº NG THÃI
   
   IF fraudDetected = TRUE THEN
       issue.status = CLOSED_FRAUD
       banCustomer(customer)
   ELSE
       issue.status = RESOLVED
   END IF

ğŸ” ÄIá»‚M Äáº¶C BIá»†T:
   â€¢ CÃ³ BH + CÃ³ CT má»›i Ä‘á»n khÃ´ng giá»›i háº¡n
   â€¢ Giá»›i háº¡n 10Ã— = tá»•ng cÆ°á»›c (khÃ´ng pháº£i cÆ°á»›c tá»· lá»‡)
   â€¢ So sÃ¡nh CT vs KB Ä‘á»ƒ xÃ¡c Ä‘á»‹nh giÃ¡ trá»‹ thá»±c
   â€¢ OFF_ROUTE: khÃ´ng giá»›i háº¡n, Ä‘á»n 100%
   â€¢ Fraud detection â†’ ban account tá»± Ä‘á»™ng

ğŸ¯ OUTPUT: CompensationDetailResponse vá»›i assessment, compensationBreakdown
   (goodsCompensation, freightRefund, totalCompensation, legalLimit, case, 
   explanation), refundInfo


================================================================================
6. LOGIC CHECK OFF ROUTE (PHÃT HIá»†N Lá»†CH TUYáº¾N)
================================================================================

ğŸ“Œ Má»¤C ÄÃCH:
   GiÃ¡m sÃ¡t GPS, phÃ¡t hiá»‡n tÃ i xáº¿ lá»‡ch tuyáº¿n, cáº£nh bÃ¡o Staff ká»‹p thá»i.

ğŸ“‹ CÆ  CHáº¾ HOáº T Äá»˜NG:

   BÆ¯á»šC 1: NHáº¬N VÃ€ Xá»¬ LÃ GPS
   
   processLocationUpdate(vehicleAssignmentId, lat, lng, speed, bearing) {
       journey = findLatestActiveJourney(vehicleAssignmentId)
       
       IF journey = NULL OR segments = NULL THEN
           RETURN NULL
       END IF
       
       distanceToRoute = calculateDistanceToRoute(lat, lng, segments)
       
       IF distanceToRoute > MAX_DISTANCE (500m) THEN
           handleOffRoute(assignment, lat, lng, distanceToRoute)
       ELSE
           handleBackOnRoute(vehicleAssignmentId)
       END IF
   }

   BÆ¯á»šC 2: TÃNH KHOáº¢NG CÃCH Äáº¾N ROUTE
   
   calculateDistanceToRoute(lat, lng, segments) {
       minDistance = INFINITY
       
       FOR each segment:
           points = segment.routePolyline
           
           FOR i = 0 TO points.length - 1:
               distance = distanceToLineSegment(
                   currentPos: (lat, lng),
                   lineSegment: (points[i], points[i+1])
               )
               
               minDistance = MIN(minDistance, distance)
           END FOR
       END FOR
       
       RETURN minDistance (meters)
   }
   
   â€¢ DÃ¹ng Haversine formula
   â€¢ TÃ­nh Ä‘áº¿n táº¥t cáº£ segments
   â€¢ Tráº£ vá» khoáº£ng cÃ¡ch ngáº¯n nháº¥t

   BÆ¯á»šC 3: Xá»¬ LÃ KHI Lá»†CH TUYáº¾N
   
   handleOffRoute(assignment, lat, lng, distanceToRoute) {
       existingEvent = findActiveByVehicleAssignmentId(assignment.id)
       
       IF existingEvent EXISTS THEN
           // Cáº­p nháº­t event hiá»‡n cÃ³
           
           // CRITICAL: Chá»‰ update náº¿u váº«n active
           IF warningStatus IN [ISSUE_CREATED, RESOLVED_SAFE, BACK_ON_ROUTE] THEN
               RETURN
           END IF
           
           event.previousDistanceFromRouteMeters = event.distanceFromRouteMeters
           event.lastKnownLat = lat
           event.lastKnownLng = lng
           event.distanceFromRouteMeters = distanceToRoute
           event.lastLocationUpdateAt = NOW
           
           checkWarningThresholds(event)
       ELSE
           // Táº¡o event má»›i
           newEvent = {
               vehicleAssignment, order,
               offRouteStartTime: NOW,
               lastKnownLat, lastKnownLng,
               distanceFromRouteMeters: distanceToRoute,
               lastLocationUpdateAt: NOW,
               warningStatus: NONE,
               canContactDriver: NULL,
               gracePeriodExtensionCount: 0
           }
           save(newEvent)
       END IF
   }

   BÆ¯á»šC 4: Há»† THá»NG Cáº¢NH BÃO PHÃ‚N Cáº¤P
   
   checkWarningThresholds(event) {
       // CRITICAL: KhÃ´ng cáº£nh bÃ¡o náº¿u khÃ´ng active
       IF warningStatus IN [ISSUE_CREATED, RESOLVED_SAFE, BACK_ON_ROUTE] THEN
           RETURN
       END IF
       
       durationMinutes = NOW - offRouteStartTime
       minutesSinceLastContact = NOW - contactedAt
       
       YELLOW WARNING (5 phÃºt):
       IF warningStatus = NONE AND durationMinutes >= 5 THEN
           event.warningStatus = YELLOW_SENT
           event.yellowWarningSentAt = NOW
           sendWarningToStaff(event, "YELLOW")
       END IF
       
       RED WARNING (10 phÃºt):
       IF warningStatus = YELLOW_SENT THEN
           shouldSendRed = FALSE
           
           IF contactedAt = NULL THEN
               // ChÆ°a liÃªn há»‡ â†’ dÃ¹ng tá»•ng thá»i gian
               shouldSendRed = durationMinutes >= 10
           ELSE
               // ÄÃ£ liÃªn há»‡ â†’ dÃ¹ng thá»i gian tá»« láº§n cuá»‘i
               shouldSendRed = minutesSinceLastContact >= 10
           END IF
           
           IF shouldSendRed THEN
               event.warningStatus = RED_SENT
               event.redWarningSentAt = NOW
               sendWarningToStaff(event, "RED")
           END IF
       END IF
   }

   BÆ¯á»šC 5: Gá»¬I Cáº¢NH BÃO QUA WEBSOCKET
   
   sendWarningToStaff(event, severity) {
       payload = {
           type: "OFF_ROUTE_WARNING",
           severity: "YELLOW" or "RED",
           offRouteEventId, vehicleAssignmentId, orderId, orderCode,
           offRouteDurationMinutes,
           lastKnownLocation: {lat, lng},
           distanceFromRouteMeters,
           driver: {id, fullName, phoneNumber},
           vehicle: {licensePlate, model},
           customer: {fullName, phoneNumber}
       }
       
       websocketService.sendToStaff("/topic/off-route-warnings", payload)
       
       // Gá»­i notification database
       createNotification(
           type: "OFF_ROUTE_WARNING",
           severity, message, staff
       )
   }

   BÆ¯á»šC 6: STAFF XÃC NHáº¬N LIÃŠN Há»†
   
   confirmContact(offRouteEventId, canContactDriver, reason) {
       event = findById(offRouteEventId)
       
       event.canContactDriver = canContactDriver
       event.contactedAt = NOW
       event.contactReason = reason
       
       IF canContactDriver = TRUE THEN
           event.warningStatus = RESOLVED_SAFE
           event.resolvedAt = NOW
           event.resolutionReason = "Staff confirmed driver is safe"
       ELSE
           // Driver khÃ´ng liÃªn láº¡c Ä‘Æ°á»£c
           
           IF gracePeriodExtensionCount < MAX_EXTENSIONS (3) THEN
               // Gia háº¡n grace period
               event.gracePeriodExtensionCount++
               event.warningStatus = YELLOW_SENT  // Reset vá» YELLOW
               event.yellowWarningSentAt = NOW
               event.contactedAt = NOW  // Reset timer
               
               sendWarningToStaff(event, "GRACE_PERIOD_EXTENDED")
           ELSE
               // Háº¿t gia háº¡n â†’ táº¡o Issue tá»± Ä‘á»™ng
               createRunawayIssue(event)
           END IF
       END IF
   }

   BÆ¯á»šC 7: Táº O ISSUE Tá»° Äá»˜NG
   
   createRunawayIssue(event) {
       issue = {
           order: event.order,
           vehicleAssignment: event.vehicleAssignment,
           issueType: "RUNAWAY_DRIVER",
           status: "PENDING",
           description: "Driver off-route >10 minutes, cannot contact",
           createdAt: NOW,
           offRouteEventId: event.id
       }
       save(issue)
       
       event.warningStatus = ISSUE_CREATED
       event.issueCreatedAt = NOW
       
       sendNotificationToManagement(issue)
   }

   BÆ¯á»šC 8: Xá»¬ LÃ KHI Vá»€ ÄÃšNG TUYáº¾N
   
   handleBackOnRoute(vehicleAssignmentId) {
       event = findActiveByVehicleAssignmentId(vehicleAssignmentId)
       
       IF event EXISTS AND warningStatus NOT IN [ISSUE_CREATED, BACK_ON_ROUTE] THEN
           event.warningStatus = BACK_ON_ROUTE
           event.resolvedAt = NOW
           event.resolutionReason = "Driver returned to route"
           save(event)
           
           sendNotificationToStaff(event, "BACK_ON_ROUTE")
       END IF
   }

   BÆ¯á»šC 9: JOB KIá»‚M TRA Äá»ŠNH Ká»² (Every 1 minute)
   
   @Scheduled(cron = "0 * * * * *")
   checkActiveOffRouteEvents() {
       activeEvents = findAllActiveEvents()
       
       FOR each event:
           checkWarningThresholds(event)
       END FOR
   }

ğŸ” ÄIá»‚M Äáº¶C BIá»†T:
   â€¢ NgÆ°á»¡ng: 500m, cáº£nh bÃ¡o vÃ ng 5 phÃºt, Ä‘á» 10 phÃºt
   â€¢ Sau liÃªn há»‡ â†’ reset timer (tÃ­nh tá»« contactedAt)
   â€¢ Gia háº¡n tá»‘i Ä‘a 3 láº§n (má»—i láº§n reset vá» YELLOW)
   â€¢ Tá»± Ä‘á»™ng táº¡o Issue náº¿u háº¿t gia háº¡n
   â€¢ WebSocket real-time cho Staff
   â€¢ Job Ä‘á»‹nh ká»³ 1 phÃºt kiá»ƒm tra

ğŸ¯ OUTPUT: OffRouteEventDetailResponse vá»›i offRouteStartTime, 
   offRouteDurationMinutes, lastKnownLocation, distanceFromRouteMeters,
   warningStatus, contactInfo, gracePeriodInfo


================================================================================
7. LOGIC TÃNH NHIÃŠN LIá»†U TIÃŠU THá»¤ (FUEL CONSUMPTION)
================================================================================

ğŸ“Œ Má»¤C ÄÃCH:
   TÃ­nh toÃ¡n nhiÃªn liá»‡u tiÃªu thá»¥ thá»±c táº¿ cá»§a xe sau má»—i chuyáº¿n hÃ ng.

ğŸ“‹ CÆ  CHáº¾ HOáº T Äá»˜NG:

   BÆ¯á»šC 1: TÃ€I Xáº¾ UPLOAD áº¢NH Äá»’NG Há»’
   
   Táº¡i 3 thá»i Ä‘iá»ƒm:
   â€¢ BEFORE_TRIP: trÆ°á»›c khi xuáº¥t phÃ¡t
   â€¢ AFTER_TRIP: sau khi hoÃ n thÃ nh giao hÃ ng
   â€¢ AFTER_RETURN: sau khi tráº£ hÃ ng vá» (náº¿u cÃ³)
   
   uploadOdometerImage(assignmentId, imageFile, recordType) {
       // Upload áº£nh lÃªn Cloudinary
       imageUrl = cloudinaryService.uploadImage(imageFile)
       
       record = {
           vehicleAssignment,
           recordType: "BEFORE_TRIP" / "AFTER_TRIP" / "AFTER_RETURN",
           odometerImageUrl: imageUrl,
           recordedAt: NOW,
           uploadedByDriver: currentDriver
       }
       save(record)
   }

   BÆ¯á»šC 2: TÃNH NHIÃŠN LIá»†U QUA Äá»’NG Há»’ (Æ¯u tiÃªn)
   
   calculateFuelConsumptionByOdometer(assignmentId) {
       beforeRecord = findByType(assignmentId, "BEFORE_TRIP")
       afterRecord = findByType(assignmentId, "AFTER_TRIP")
       returnRecord = findByType(assignmentId, "AFTER_RETURN")
       
       IF beforeRecord = NULL OR afterRecord = NULL THEN
           THROW "Missing odometer records"
       END IF
       
       // Parse sá»‘ km tá»« áº£nh (hoáº·c Staff nháº­p manual)
       startOdometer = beforeRecord.odometerReading
       endOdometer = returnRecord?.odometerReading ?? afterRecord.odometerReading
       
       totalDistanceKm = endOdometer - startOdometer
       
       IF totalDistanceKm <= 0 OR totalDistanceKm > 10000 THEN
           THROW "Invalid distance: " + totalDistanceKm
       END IF
       
       // Láº¥y base fuel rate tá»« vehicleType
       vehicle = assignment.vehicle
       baseFuelRate = vehicle.vehicleType.fuelConsumptionRate  // lÃ­t/100km
       
       IF baseFuelRate = NULL OR baseFuelRate <= 0 THEN
           THROW "Missing fuel rate for vehicle type"
       END IF
       
       // TÃ­nh nhiÃªn liá»‡u vá»›i load factor
       journey = assignment.journey
       deliveryDistance = journey.totalDistanceKm ?? 0
       returnDistance = totalDistanceKm - deliveryDistance
       
       // Giáº£ Ä‘á»‹nh: 60% full load (cÃ³ hÃ ng), 40% empty (khÃ´ng hÃ ng)
       FULL_LOAD_FACTOR = 1.2   // TÄƒng 20% khi cÃ³ hÃ ng
       EMPTY_LOAD_FACTOR = 0.8  // Giáº£m 20% khi khÃ´ng hÃ ng
       
       fuelForDelivery = (deliveryDistance / 100) Ã— baseFuelRate Ã— FULL_LOAD_FACTOR
       fuelForReturn = (returnDistance / 100) Ã— baseFuelRate Ã— EMPTY_LOAD_FACTOR
       
       totalFuelConsumed = fuelForDelivery + fuelForReturn
       
       IF totalFuelConsumed <= 0 OR totalFuelConsumed > 10000 THEN
           THROW "Invalid fuel consumption"
       END IF
       
       // LÆ°u káº¿t quáº£
       fuelRecord = {
           vehicleAssignment, vehicle, journey,
           calculationMethod: "ODOMETER_BASED",
           startOdometerReading: startOdometer,
           endOdometerReading: endOdometer,
           totalDistanceTraveled: totalDistanceKm,
           baseFuelConsumptionRate: baseFuelRate,
           fullLoadFactor: 1.2,
           emptyLoadFactor: 0.8,
           deliveryDistanceKm: deliveryDistance,
           returnDistanceKm: returnDistance,
           fuelUsedForDelivery: fuelForDelivery,
           fuelUsedForReturn: fuelForReturn,
           totalFuelConsumed: totalFuelConsumed,
           recordedAt: NOW
       }
       save(fuelRecord)
       
       // Cáº­p nháº­t tráº¡ng thÃ¡i
       updateOrderStatus(order, "FUEL_RECORDED")
       updateVehicleStatus(vehicle, "AVAILABLE")
       
       RETURN fuelRecord
   }

   BÆ¯á»šC 3: TÃNH NHIÃŠN LIá»†U QUA SEGMENT (Fallback)
   
   calculateFuelConsumptionBySegments(assignmentId) {
       journey = findJourneyByAssignment(assignmentId)
       segments = journey.segments
       
       IF segments.isEmpty THEN
           THROW "No segments found"
       END IF
       
       vehicle = assignment.vehicle
       baseFuelRate = vehicle.vehicleType.fuelConsumptionRate
       
       totalFuel = 0
       totalDistance = 0
       
       FOR each segment IN segments:
           segmentDistance = segment.distanceKm
           
           // XÃ¡c Ä‘á»‹nh load factor theo segment type
           IF segment.type = "PICKUP" OR segment.type = "DELIVERY" THEN
               loadFactor = 1.2  // CÃ³ hÃ ng
           ELSE IF segment.type = "RETURN" THEN
               loadFactor = 0.8  // KhÃ´ng hÃ ng
           ELSE
               loadFactor = 1.0  // Máº·c Ä‘á»‹nh
           END IF
           
           segmentFuel = (segmentDistance / 100) Ã— baseFuelRate Ã— loadFactor
           totalFuel += segmentFuel
           totalDistance += segmentDistance
       END FOR
       
       fuelRecord = {
           vehicleAssignment, vehicle, journey,
           calculationMethod: "SEGMENT_BASED",
           totalDistanceTraveled: totalDistance,
           baseFuelConsumptionRate: baseFuelRate,
           totalFuelConsumed: totalFuel,
           calculationNote: "Fallback: Odometer not available",
           recordedAt: NOW
       }
       save(fuelRecord)
       
       RETURN fuelRecord
   }

   BÆ¯á»šC 4: Xá»¬ LÃ Lá»–I VÃ€ FALLBACK
   
   recordFuelConsumption(assignmentId) {
       TRY {
           // Æ¯u tiÃªn phÆ°Æ¡ng phÃ¡p odometer
           RETURN calculateFuelConsumptionByOdometer(assignmentId)
       }
       CATCH (MissingOdometerException e) {
           LOG.warn("Odometer missing, using segment-based calculation")
           RETURN calculateFuelConsumptionBySegments(assignmentId)
       }
       CATCH (InvalidDataException e) {
           LOG.error("Invalid odometer data, using segment-based calculation")
           RETURN calculateFuelConsumptionBySegments(assignmentId)
       }
       CATCH (Exception e) {
           LOG.error("Fuel calculation failed", e)
           THROW e
       }
   }

   BÆ¯á»šC 5: Cáº¬P NHáº¬T TRáº NG THÃI
   
   Sau khi tÃ­nh xong:
   
   â€¢ Order.status â†’ FUEL_RECORDED
   â€¢ Vehicle.status â†’ AVAILABLE
   â€¢ VehicleAssignment.fuelConsumptionRecorded â†’ TRUE
   â€¢ Journey.fuelConsumptionCalculated â†’ TRUE

ğŸ” ÄIá»‚M Äáº¶C BIá»†T:
   â€¢ Æ¯u tiÃªn odometer (chÃ­nh xÃ¡c hÆ¡n)
   â€¢ Fallback segment-based náº¿u thiáº¿u áº£nh
   â€¢ Load factor: 60% full (1.2Ã—), 40% empty (0.8Ã—)
   â€¢ Validate khoáº£ng há»£p lÃ½: 0-10,000 km, 0-10,000 lÃ­t
   â€¢ Tá»± Ä‘á»™ng cáº­p nháº­t tráº¡ng thÃ¡i order vÃ  vehicle
   â€¢ LÆ°u cáº£ 2 phÆ°Æ¡ng phÃ¡p Ä‘á»ƒ so sÃ¡nh

ğŸ¯ OUTPUT: VehicleFuelConsumptionRecord vá»›i:
   â€¢ calculationMethod: "ODOMETER_BASED" hoáº·c "SEGMENT_BASED"
   â€¢ totalDistanceTraveled, totalFuelConsumed
   â€¢ breakdown: deliveryDistance, returnDistance, fuelForEach
   â€¢ baseFuelRate, loadFactors
   â€¢ odometerReadings (náº¿u cÃ³)


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                              Káº¾T LUáº¬N                                         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Há»‡ thá»‘ng Truckie triá»ƒn khai 7 luá»“ng nghiá»‡p vá»¥ phá»©c táº¡p vá»›i logic cháº·t cháº½:

1. BinPacker: Tá»‘i Æ°u 3D bin packing vá»›i 3 chiáº¿n lÆ°á»£c thÃ´ng minh
2. Pricing: CÃ´ng thá»©c tÃ­nh giÃ¡ linh hoáº¡t vá»›i nhiá»u phá»¥ phÃ­
3. Driver Assignment: Cháº¥m Ä‘iá»ƒm Ä‘a yáº¿u tá»‘, cÃ¢n báº±ng workload
4. Return Shipping: TÃ­nh cÆ°á»›c tráº£ hÃ ng chÃ­nh xÃ¡c theo tá»«ng kiá»‡n
5. Compensation: 4 cases bá»“i thÆ°á»ng rÃµ rÃ ng, phÃ¡t hiá»‡n gian láº­n
6. Off-route: 3-tier warning, grace period, auto issue creation
7. Fuel Consumption: Odometer-first vá»›i segment-based fallback

Táº¥t cáº£ Ä‘á»u cÃ³ validation cháº·t, error handling Ä‘áº§y Ä‘á»§, vÃ  audit trail chi tiáº¿t.
